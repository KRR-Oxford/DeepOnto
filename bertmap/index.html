
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Yuan He (KRR-Oxford)">
      
      
        <link rel="canonical" href="https://krr-oxford.github.io/DeepOnto/bertmap/">
      
      
        <link rel="prev" href="../ontology/">
      
      
        <link rel="next" href="../om_resources/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.5">
    
    
      
        <title>Using BERTMap and BERTMapLt - DeepOnto</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-bertmap-and-bertmaplt" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="DeepOnto" class="md-header__button md-logo" aria-label="DeepOnto" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DeepOnto
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Using BERTMap and BERTMapLt
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/KRR-Oxford/DeepOnto" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="DeepOnto" class="md-nav__button md-logo" aria-label="DeepOnto" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    DeepOnto
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/KRR-Oxford/DeepOnto" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_1" type="checkbox" id="__nav_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_1" tabindex="0" aria-expanded="true">
          GET STARTED
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="GET STARTED" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          GET STARTED
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ontology/" class="md-nav__link">
        Using Ontology
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Using BERTMap and BERTMapLt
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Using BERTMap and BERTMapLt
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
    <nav class="md-nav" aria-label="Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bertmap-or-bertmaplt" class="md-nav__link">
    BERTMap or BERTMapLt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#annotation-properties" class="md-nav__link">
    Annotation Properties
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-training-data" class="md-nav__link">
    Additional Training Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bert-settings" class="md-nav__link">
    BERT Settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#global-matching-settings" class="md-nav__link">
    Global Matching Settings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#output-format" class="md-nav__link">
    Output Format
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../om_resources/" class="md-nav__link">
        Bio-ML Specifications
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" tabindex="0" aria-expanded="false">
          PACKAGE REFERENCE
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="PACKAGE REFERENCE" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          PACKAGE REFERENCE
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/onto/" class="md-nav__link">
        Ontology
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" tabindex="0" aria-expanded="false">
          Ontology Alignment
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ontology Alignment" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Ontology Alignment
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/align/mapping/" class="md-nav__link">
        Mapping
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/align/bertmap/" class="md-nav__link">
        BERTMap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/align/logmap/" class="md-nav__link">
        LogMap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/align/evaluation/" class="md-nav__link">
        Evaluation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" tabindex="0" aria-expanded="false">
          Utilities
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utilities" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/utils/text_utils/" class="md-nav__link">
        Text Utilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/utils/file_utils/" class="md-nav__link">
        File Utilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/utils/logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/utils/data_utils/" class="md-nav__link">
        Data Utilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deeponto/utils/decorators/" class="md-nav__link">
        Decorators
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="using-bertmap-and-bertmaplt">Using BERTMap and BERTMapLt</h1>
<div class="admonition credit">
<p class="admonition-title">Paper</p>
<p><span class="arithmatex">\(\textsf{BERTMap}\)</span> is proposed in the paper:
<em><a href="https://ojs.aaai.org/index.php/AAAI/article/view/20510">BERTMap: A BERT-based Ontology Alignment System (AAAI-2022)</a></em>.</p>
</div>
<p>This page gives the tutorial for <span class="arithmatex">\(\textsf{BERTMap}\)</span> family including the summary of the models and how to use them.</p>
<h2 id="overview">Overview</h2>
<p align="center">
    <img alt="deeponto" src="../images/bertmap.svg">
    <p align="center">Figure 1. Pipeline illustration of BERTMap.</p>
</p>

<p><br>
The ontology matching (OM) pipeline of <span class="arithmatex">\(\textsf{BERTMap}\)</span> consists of following steps:</p>
<ol>
<li>Load the source and target ontologies and build <strong>annotation indices</strong> from them based on selected annotation properties.</li>
<li>Construct the <strong>text semantics corpora</strong> including <strong>intra-ontology</strong> (from input ontologies), <strong>cross-ontology</strong> (optional, from input mappings), and <strong>auxiliary</strong> (optional, from auxiliary ontologies) sub-corpora. </li>
<li>Split samples in the form of <code>(src_annotation, tgt_annotation, synonym_label)</code> into training and validation splits.</li>
<li>Fine-tune a <strong>BERT synonym classifier</strong> on the samples and obtain the best checkpoint on the validation split.</li>
<li>
<p>Predict mappings for each class <span class="arithmatex">\(c\)</span> of the source ontology <span class="arithmatex">\(\mathcal{O}\)</span> by:</p>
<ul>
<li>Selecting plausible candidates <span class="arithmatex">\(c'\)</span>s in the target ontology <span class="arithmatex">\(\mathcal{O'}\)</span> based on <strong>idf scores</strong> w.r.t. the <strong>sub-word inverted index</strong> built from the target ontology annotation index.
For <span class="arithmatex">\(c\)</span> and a candidate <span class="arithmatex">\(c'\)</span>. first check if they can be string-matched (i.e., share a common annotation, or equivalently the maximum edit similarity score is <span class="arithmatex">\(1.0\)</span>); if not,
consider all combinations (cartesian product) of their respective class annotations, compute a synonym score for each combination, and take the <strong>average of synonym scores as the mapping score</strong>.</li>
<li><span class="arithmatex">\(N\)</span> best scored mappings (no filtering) will be preserved as raw predictions which should have relatively higher recall and lower precision.</li>
</ul>
</li>
<li>
<p>Extend the raw predictions using an <strong>iterative</strong> algorithm based on the <strong>locality principle</strong>. To be specific, if <span class="arithmatex">\(c\)</span> and <span class="arithmatex">\(c'\)</span> are matched with a <strong>relatively high mapping score</strong> (<span class="arithmatex">\(\geq \kappa\)</span>), then search for plausible mappings between the <em>parents</em> (resp. <em>children</em>) of <span class="arithmatex">\(c\)</span> and the <em>parents</em> (resp. <em>children</em>) of <span class="arithmatex">\(c'\)</span>. This process is iterative because there would be new
highly scored mappings at each round. Terminate mapping extension when there is no
new mapping with score <span class="arithmatex">\(\geq \kappa\)</span> found or exceed the maximum number of iterations. Note that <span class="arithmatex">\(\kappa\)</span> is set to <span class="arithmatex">\(0.9\)</span> by default same as in the original paper.</p>
</li>
<li>
<p>Truncate the extended mappings by preserving only those with scores <span class="arithmatex">\(\geq \lambda\)</span>. In the original paper, <span class="arithmatex">\(\lambda\)</span> is supposed to be tuned on validation mappings – which are often not available. Also, <span class="arithmatex">\(\lambda\)</span> is not a sensitive hyperparameter in practice. Therefore, we manually set <span class="arithmatex">\(\lambda\)</span> to <span class="arithmatex">\(0.9995\)</span> as a default value which usually yields a higher F1 score. Note that both <span class="arithmatex">\(\kappa\)</span> and <span class="arithmatex">\(\lambda\)</span> are made available in the configuration file.</p>
</li>
<li>
<p>Repair the rest of the mappings with the repair module built in LogMap (BERTMap does not focus on mapping repair). In short, a minimum set of inconsistent mappings will be removed (further improve precision).</p>
</li>
</ol>
<p>Steps 5-8 are referred to as the <strong>global matching</strong> process which computes OM mappings from two input ontologies. <span class="arithmatex">\(\textsf{BERTMapLt}\)</span> is the light-weight version without BERT training and mapping refinement. The mapping filtering threshold for <span class="arithmatex">\(\textsf{BERTMapLt}\)</span> is <span class="arithmatex">\(1.0\)</span> (i.e., string-matched). </p>
<p>In addition to the traditional OM procedure, the scoring modules of <span class="arithmatex">\(\textsf{BERTMap}\)</span> and <span class="arithmatex">\(\textsf{BERTMapLt}\)</span> can be used to evaluate any class pair given their selected annotations. This is useful in ranking-based evaluation. </p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <span class="arithmatex">\(\textsf{BERTMap}\)</span> family rely on sufficient class annotations for constructing training corpora
of the BERT synonym classifier, especially under the <strong>unsupervised</strong> setting where the are no input mappings and/or external resources. It is very important to specify correct <a href="#annotation-properties"><strong>annotation properties</strong></a> in the configuration file.</p>
</div>
<h2 id="usage">Usage</h2>
<p>To use <span class="arithmatex">\(\textsf{BERTMap}\)</span>, import the configuration file and two input ontologies to be matched.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">deeponto.onto</span> <span class="kn">import</span> <span class="n">Ontology</span>
<span class="kn">from</span> <span class="nn">deeponto.align.bertmap</span> <span class="kn">import</span> <span class="n">BERTMapPipeline</span>

<span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;path_to_config.yaml&quot;</span>
<span class="n">src_onto_file</span> <span class="o">=</span> <span class="s2">&quot;path_to_the_source_ontology.owl&quot;</span>  
<span class="n">tgt_onto_file</span> <span class="o">=</span> <span class="s2">&quot;path_to_the_target_ontology.owl&quot;</span> 

<span class="n">config</span> <span class="o">=</span> <span class="n">BERTMapPipeline</span><span class="o">.</span><span class="n">load_bertmap_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
<span class="n">src_onto</span> <span class="o">=</span> <span class="n">Ontology</span><span class="p">(</span><span class="n">src_onto_file</span><span class="p">)</span>
<span class="n">tgt_onto</span> <span class="o">=</span> <span class="n">Ontology</span><span class="p">(</span><span class="n">tgt_onto_file</span><span class="p">)</span>

<span class="n">BERTMapPipeline</span><span class="p">(</span><span class="n">src_onto</span><span class="p">,</span> <span class="n">tgt_onto</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</code></pre></div>
<p>The default configuration file can be loaded as:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">deeponto.align.bertmap</span> <span class="kn">import</span> <span class="n">BERTMapPipeline</span><span class="p">,</span> <span class="n">DEFAULT_CONFIG_FILE</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">BERTMapPipeline</span><span class="o">.</span><span class="n">load_bertmap_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_FILE</span><span class="p">)</span>
</code></pre></div>
<p>The loaded configuration is a <code>CfgNode</code> object supporting attribute access of dictionary keys. 
To customise the configuration, users can either copy the <code>DEFAULT_CONFIG_FILE</code>, save it locally using <code>BERTMapPipeline.save_bertmap_config</code> method, and modify it accordingly; or change it in the run time.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">deeponto.align.bertmap</span> <span class="kn">import</span> <span class="n">BERTMapPipeline</span><span class="p">,</span> <span class="n">DEFAULT_CONFIG_FILE</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">BERTMapPipeline</span><span class="o">.</span><span class="n">load_bertmap_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_FILE</span><span class="p">)</span>

<span class="c1"># save the configuration file</span>
<span class="n">BERTMapPipeline</span><span class="o">.</span><span class="n">save_bertmap_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;path_to_saved_config.yaml&quot;</span><span class="p">)</span>

<span class="c1"># modify it in the run time</span>
<span class="c1"># for example, add more annotation properties for synonyms</span>
<span class="n">config</span><span class="o">.</span><span class="n">annotation_property_iris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;http://...&quot;</span><span class="p">)</span> 
</code></pre></div>
<p>If using <span class="arithmatex">\(\textsf{BERTMap}\)</span> for scoring class pairs instead of global matching, disable automatic global matching and load class pairs to be scored.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">deeponto.onto</span> <span class="kn">import</span> <span class="n">Ontology</span>
<span class="kn">from</span> <span class="nn">deeponto.align.bertmap</span> <span class="kn">import</span> <span class="n">BERTMapPipeline</span>

<span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;path_to_config.yaml&quot;</span>
<span class="n">src_onto_file</span> <span class="o">=</span> <span class="s2">&quot;path_to_the_source_ontology.owl&quot;</span>  
<span class="n">tgt_onto_file</span> <span class="o">=</span> <span class="s2">&quot;path_to_the_target_ontology.owl&quot;</span> 

<span class="n">config</span> <span class="o">=</span> <span class="n">BERTMapPipeline</span><span class="o">.</span><span class="n">load_bertmap_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">global_match</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">src_onto</span> <span class="o">=</span> <span class="n">Ontology</span><span class="p">(</span><span class="n">src_onto_file</span><span class="p">)</span>
<span class="n">tgt_onto</span> <span class="o">=</span> <span class="n">Ontology</span><span class="p">(</span><span class="n">tgt_onto_file</span><span class="p">)</span>

<span class="n">bertmap</span> <span class="o">=</span> <span class="n">BERTMapPipeline</span><span class="p">(</span><span class="n">src_onto</span><span class="p">,</span> <span class="n">tgt_onto</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

<span class="n">class_pairs_to_be_scored</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>  <span class="c1"># (src_class_iri, tgt_class_iri)</span>
<span class="k">for</span> <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span> <span class="ow">in</span> <span class="n">class_pairs_to_be_scored</span><span class="p">:</span>
    <span class="c1"># retrieve class annotations</span>
    <span class="n">src_class_annotations</span> <span class="o">=</span> <span class="n">bertmap</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">[</span><span class="n">src_class_iri</span><span class="p">]</span>
    <span class="n">tgt_class_annotations</span> <span class="o">=</span> <span class="n">bertmap</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">[</span><span class="n">tgt_class_iri</span><span class="p">]</span>
    <span class="c1"># the bertmap score</span>
    <span class="n">bertmap_score</span> <span class="o">=</span> <span class="n">bertmap</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">bert_mapping_score</span><span class="p">(</span>
        <span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span>
    <span class="p">)</span>
    <span class="c1"># the bertmaplt score</span>
    <span class="n">bertmaplt_score</span> <span class="o">=</span> <span class="n">bertmap</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">edit_similarity_mapping_score</span><span class="p">(</span>
        <span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span>
    <span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The implemented <span class="arithmatex">\(\textsf{BERTMap}\)</span> by default searches <strong>for each source ontology class</strong> a set of possible matched target ontology classes.
Because of this, it is recommended to set the source ontology as the one with a <strong>smaller number of classes</strong> for efficiency.</p>
<p>Note that in the original paper, the model is expected to match for both directions <code>src2tgt</code> and <code>tgt2src</code>, and also consider the combination
of both results. However, this does not usually bring better performance and significantly consumes more time. Therefore, this feature is discarded
and the users can choose which direction to match.</p>
</div>
<h2 id="configuration">Configuration</h2>
<p>The default configuration file looks like:</p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bertmap</span><span class="w">  </span><span class="c1"># bertmap or bertmaplt</span>

<span class="nt">output_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w">  </span><span class="c1"># if not provided, the current path &quot;.&quot; is used</span>

<span class="nt">annotation_property_iris</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://www.w3.org/2000/01/rdf-schema#label</span><span class="w">  </span><span class="c1"># rdfs:label</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://www.geneontology.org/formats/oboInOwl#hasSynonym</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://www.geneontology.org/formats/oboInOwl#hasExactSynonym</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://www.w3.org/2004/02/skos/core#exactMatch</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://www.ebi.ac.uk/efo/alternative_term</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://www.orpha.net/ORDO/Orphanet_#symbol</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://purl.org/sig/ont/fma/synonym</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://www.w3.org/2004/02/skos/core#prefLabel</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://www.w3.org/2004/02/skos/core#altLabel</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl#P108</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl#P90</span>

<span class="c1"># additional corpora </span>
<span class="nt">known_mappings</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w">  </span><span class="c1"># cross-ontology corpus</span>
<span class="nt">auxiliary_ontos</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"> </span><span class="c1"># auxiliary corpus</span>

<span class="c1"># bert config</span>
<span class="nt">bert</span><span class="p">:</span><span class="w">  </span>
<span class="w">  </span><span class="nt">pretrained_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">emilyalsentzer/Bio_ClinicalBERT</span><span class="w">  </span>
<span class="w">  </span><span class="nt">max_length_for_input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span><span class="w"> </span>
<span class="w">  </span><span class="nt">num_epochs_for_training</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0</span>
<span class="w">  </span><span class="nt">batch_size_for_training</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="w">  </span><span class="nt">batch_size_for_prediction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<span class="w">  </span><span class="nt">resume_training</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>

<span class="c1"># global matching config</span>
<span class="nt">global_matching</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">num_raw_candidates</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span><span class="w"> </span>
<span class="w">  </span><span class="nt">num_best_predictions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"> </span>
<span class="w">  </span><span class="nt">mapping_extension_threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.9</span><span class="w">   </span>
<span class="w">  </span><span class="nt">mapping_filtered_threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.9995</span><span class="w"> </span>
</code></pre></div>
<h3 id="bertmap-or-bertmaplt">BERTMap or BERTMapLt</h3>
<p>By changing the <code>config.model</code> parameter to <code>bertmap</code> or <code>bertmaplt</code>, users can switch between 
<span class="arithmatex">\(\textsf{BERTMap}\)</span> and <span class="arithmatex">\(\textsf{BERTMapLt}\)</span>. Note that <span class="arithmatex">\(\textsf{BERTMapLt}\)</span> does not use any
training and mapping refinement parameters.</p>
<h3 id="annotation-properties">Annotation Properties <img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /></h3>
<p>The IRIs stored in <code>config.annotation_property_iris</code> refer to annotation properties with literal values
that define the <strong>synonyms</strong> of an ontology class. Many ontology matching systems rely on synonyms for good performance, including the <span class="arithmatex">\(\textsf{BERTMap}\)</span> family. The default <code>config.annotation_property_iris</code> are in line with the <strong>Bio-ML</strong> dataset, which will be constantly updated. Users can append or delete IRIs for specific input ontologies.</p>
<p>Note that it is safe to specify all possible annotation properties regardless of input ontologies because the ones that are not used will be ignored.</p>
<h3 id="additional-training-data">Additional Training Data</h3>
<p>The <strong>text semantics corpora</strong> by default (unsupervised setting) will consist of two <strong>intra-ontology sub-corpora</strong> built from two input ontologies (based on the specified annotation properties). To add more training data, users can opt to feed input mappings (<strong>cross-ontology sub-corpus</strong>) and/or a list of auxiliary ontologies (<strong>auxiliary sub-corpora</strong>). </p>
<p>Specify the path to input mapping file in <code>config.known_mappings</code>; the input mapping file should be a <code>.tsv</code> or <code>.csv</code> file with three columns with headings: <code>["SrcEntity", "TgtEntity", "Score"]</code>. Each row corresponds to a triple <span class="arithmatex">\((c, c', s(c, c'))\)</span> where <span class="arithmatex">\(c\)</span> is a source ontology class, <span class="arithmatex">\(c'\)</span> is a target ontology class, and <span class="arithmatex">\(s(c, c')\)</span> is the matching score. Note that in the BERTMap context, input mapppings are assumed to be gold standard (reference) mappings with scores equal to <span class="arithmatex">\(1.0\)</span>. Regardless of scores specified in the mapping file, the scores of the input mapppings will be adjusted to <span class="arithmatex">\(1.0\)</span> automatically.</p>
<p>Specify a list of paths to auxiliary ontology files in <code>config.auxiliary_ontos</code>. For each auxiliary ontology, a corresponding intra-ontology corpus will be created and thus produce more synonym and non-synonym samples.</p>
<h3 id="bert-settings">BERT Settings</h3>
<p><span class="arithmatex">\(\textsf{BERTMap}\)</span> uses the pre-trained <strong>Bio-Clincal BERT</strong> as specified in <code>config.bert.pretrained_path</code> because it was originally applied on biomedical ontologies. For general purpose ontology matching, users can use pre-trained variants such as <code>bert-base-uncased</code>.</p>
<p>Adjust <code>config.bert.batch_size_for_training</code> and <code>config.bert.batch_size_for_prediction</code> if users found an inappropriate GPU memory fit. Set <code>config.bert.resume_training</code> to <code>true</code> if the BERT training process is somehow interrupted and users wish to continue training.</p>
<h3 id="global-matching-settings">Global Matching Settings</h3>
<p>As mentioned in <a href="#usage">usage</a>, users can disable automatic global matching by setting <code>config.global_matching.enabled</code> to <code>false</code> if they wish to use the mapping scoring module only. </p>
<p><code>config.global_matching.num_raw_candidates</code> corresponds to the number of raw candidates selected in the mapping prediction phase. </p>
<p><code>config.global_matching.num_best_predictions</code> corresponds to the number of best scored mappings preserved in the mapping prediction phase. The default value <code>10</code> is often more than enough.</p>
<p><code>config.global_matching.mapping_extension_threshold</code> corresponds to the score threshold of mappings used in the iterative mapping extension process. Higher value shortens the time but reduces the recall. </p>
<p><code>config.global_matching.mapping_filtered_threshold</code> corresponds to the score threshold of mappings preserved for final mapping refinement. </p>
<h2 id="output-format">Output Format</h2>
<p>Running <span class="arithmatex">\(\textsf{BERTMap}\)</span> will create a directory named <code>bertmap</code> or <code>bertmaplt</code> in the specified output path.
The file structure of this directory is as follows:</p>
<div class="highlight"><pre><span></span><code>bertmap
├── data
│   ├── fine-tune.data.json
│   └── text-semantics.corpora.json
├── bertmap.log
├── bert
│   ├── tensorboard
│   ├── checkpoint-{some_number}
│   └── checkpoint-{some_number}
├── match
│   ├── logmap-repair
│   ├── raw_mappings.json
│   ├── repaired_mappings.tsv 
│   ├── raw_mappings.tsv
│   ├── extended_mappings.tsv
│   └── filtered_mappings.tsv
└── config.yaml
</code></pre></div>
<p>It is worth mentioning that the <code>match</code> sub-directory contains all the global matching files:</p>
<ul>
<li><code>raw_mappings.tsv</code> refers to the raw mapping predictions before mapping refinement. The <code>.json</code> one is used internally to prevent accidental interruption. Note that <code>bertmaplt</code> only produces raw mapping predictions (no mapping refinement).</li>
<li><code>extended_mappings.tsv</code> refers to the output mappings after applying mapping extension. </li>
<li><code>filtered_mappings.tsv</code> refers to the output mappings after mapping extension and threshold filtering. </li>
<li><code>logmap-repair</code> is a folder containing intermediate files needed for applying LogMap's debugger.</li>
<li><code>repaired_mappings.tsv</code> refers to the <strong>final</strong> output mappings after mapping repair.</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 Yuan He (KRR-Oxford)
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "toc.integrate", "navigation.top", "header.autohide", "toc.follow", "content.code.copy"], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": "0.5.0"}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>
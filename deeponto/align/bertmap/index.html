
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Yuan He (KRR-Oxford)">
      
      
        <link rel="canonical" href="https://krr-oxford.github.io/DeepOnto/deeponto/align/bertmap/">
      
      
        <link rel="prev" href="../mapping/">
      
      
        <link rel="next" href="../logmap/">
      
      <link rel="icon" href="../../../images/favicon_package/favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.5">
    
    
      
        <title>BERTMap - DeepOnto</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="DeepOnto" class="md-header__button md-logo" aria-label="DeepOnto" data-md-component="logo">
      
  <img src="../../../images/favicon_package/safari-pinned-tab.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DeepOnto
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              BERTMap
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/KRR-Oxford/DeepOnto" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    KRR-Oxford/DeepOnto
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to configuration -->



  


<!-- Main navigation -->
<nav
  class="md-nav md-nav--primary md-nav--integrated"
  aria-label="Navigation"
  data-md-level="0"
>

  <!-- Site title -->
  <label class="md-nav__title" for="__drawer">
    <a
      href="../../.."
      title="DeepOnto"
      class="md-nav__button md-logo"
      aria-label="DeepOnto"
      data-md-component="logo"
    >
      
  <img src="../../../images/favicon_package/safari-pinned-tab.svg" alt="logo">

    </a>
    <!-- DeepOnto -->
  </label>

  <!-- Repository information -->
  
    <div class="md-nav__source">
      <a href="https://github.com/KRR-Oxford/DeepOnto" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    KRR-Oxford/DeepOnto
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
        <label class="md-nav__link" for="__nav_1" tabindex="0" aria-expanded="false">
          GET STARTED
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="GET STARTED" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          GET STARTED
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ontology/" class="md-nav__link">
        Using Ontology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../bertmap/" class="md-nav__link">
        Using BERTMap and BERTMapLt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../bio-ml/" class="md-nav__link">
        Bio-ML Specifications
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2" tabindex="0" aria-expanded="true">
          PACKAGE REFERENCE
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="PACKAGE REFERENCE" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          PACKAGE REFERENCE
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../onto/" class="md-nav__link">
        Ontology
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2_2" tabindex="0" aria-expanded="true">
          Ontology Alignment
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ontology Alignment" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Ontology Alignment
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mapping/" class="md-nav__link">
        Mapping
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          BERTMap
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        BERTMap
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline" class="md-nav__link">
    BERTMapPipeline
  </a>
  
    <nav class="md-nav" aria-label="BERTMapPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline.load_or_construct" class="md-nav__link">
    load_or_construct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline.load_text_semantics_corpora" class="md-nav__link">
    load_text_semantics_corpora()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline.load_finetune_data" class="md-nav__link">
    load_finetune_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline.load_bert_synonym_classifier" class="md-nav__link">
    load_bert_synonym_classifier()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline.load_best_checkpoint" class="md-nav__link">
    load_best_checkpoint()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline.load_bertmap_config" class="md-nav__link">
    load_bertmap_config()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.pipeline.BERTMapPipeline.save_bertmap_config" class="md-nav__link">
    save_bertmap_config()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus" class="md-nav__link">
    AnnotationThesaurus
  </a>
  
    <nav class="md-nav" aria-label="AnnotationThesaurus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus.get_synonym_pairs" class="md-nav__link">
    get_synonym_pairs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus.merge_synonym_groups_by_transitivity" class="md-nav__link">
    merge_synonym_groups_by_transitivity()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus.connected_annotations" class="md-nav__link">
    connected_annotations()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus.synonym_sampling" class="md-nav__link">
    synonym_sampling()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus.soft_nonsynonym_sampling" class="md-nav__link">
    soft_nonsynonym_sampling()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus.weighted_random_choices_of_sibling_groups" class="md-nav__link">
    weighted_random_choices_of_sibling_groups()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus.hard_nonsynonym_sampling" class="md-nav__link">
    hard_nonsynonym_sampling()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.IntraOntologyTextSemanticsCorpus" class="md-nav__link">
    IntraOntologyTextSemanticsCorpus
  </a>
  
    <nav class="md-nav" aria-label="IntraOntologyTextSemanticsCorpus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.IntraOntologyTextSemanticsCorpus.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus" class="md-nav__link">
    CrossOntologyTextSemanticsCorpus
  </a>
  
    <nav class="md-nav" aria-label="CrossOntologyTextSemanticsCorpus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus.synonym_sampling_from_mappings" class="md-nav__link">
    synonym_sampling_from_mappings()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus.nonsynonym_sampling_from_mappings" class="md-nav__link">
    nonsynonym_sampling_from_mappings()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.TextSemanticsCorpora" class="md-nav__link">
    TextSemanticsCorpora
  </a>
  
    <nav class="md-nav" aria-label="TextSemanticsCorpora">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.TextSemanticsCorpora.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.text_semantics.TextSemanticsCorpora.add_samples_from_sub_corpus" class="md-nav__link">
    add_samples_from_sub_corpus()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier" class="md-nav__link">
    BERTSynonymClassifier
  </a>
  
    <nav class="md-nav" aria-label="BERTSynonymClassifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.eval" class="md-nav__link">
    eval()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.predict" class="md-nav__link">
    predict()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.load_dataset" class="md-nav__link">
    load_dataset()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.process_inputs" class="md-nav__link">
    process_inputs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.compute_metrics" class="md-nav__link">
    compute_metrics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.get_device" class="md-nav__link">
    get_device()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.set_seed" class="md-nav__link">
    set_seed()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_prediction.MappingPredictor" class="md-nav__link">
    MappingPredictor
  </a>
  
    <nav class="md-nav" aria-label="MappingPredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_prediction.MappingPredictor.bert_mapping_score" class="md-nav__link">
    bert_mapping_score()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_prediction.MappingPredictor.edit_similarity_mapping_score" class="md-nav__link">
    edit_similarity_mapping_score()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_prediction.MappingPredictor.mapping_prediction_for_src_class" class="md-nav__link">
    mapping_prediction_for_src_class()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_prediction.MappingPredictor.mapping_prediction" class="md-nav__link">
    mapping_prediction()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_refinement.MappingRefiner" class="md-nav__link">
    MappingRefiner
  </a>
  
    <nav class="md-nav" aria-label="MappingRefiner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_refinement.MappingRefiner.mapping_extension" class="md-nav__link">
    mapping_extension()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_refinement.MappingRefiner.one_hop_extend" class="md-nav__link">
    one_hop_extend()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_refinement.MappingRefiner.mapping_repair" class="md-nav__link">
    mapping_repair()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deeponto.align.bertmap.mapping_refinement.MappingRefiner.logmap_repair_formatting" class="md-nav__link">
    logmap_repair_formatting()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../logmap/" class="md-nav__link">
        LogMap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/" class="md-nav__link">
        Evaluation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" tabindex="0" aria-expanded="false">
          Utilities
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utilities" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/text_utils/" class="md-nav__link">
        Text Utilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/file_utils/" class="md-nav__link">
        File Utilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/data_utils/" class="md-nav__link">
        Data Utilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/decorators/" class="md-nav__link">
        Decorators
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  
                  

  
  



  <h1>BERTMap</h1>

<div class="admonition credit">
<p class="admonition-title">Paper</p>
<p><span class="arithmatex">\(\textsf{BERTMap}\)</span> is proposed in the paper:
<a href="https://ojs.aaai.org/index.php/AAAI/article/view/20510">BERTMap: A BERT-based Ontology Alignment System (AAAI-2022)</a>.</p>
</div>
<p><span class="arithmatex">\(\textsf{BERTMap}\)</span> is a BERT-based ontology matching (OM) system consisting of following components:</p>
<ul>
<li><strong>Text semantics corpora</strong> construction from input ontologies, and optionally from input mappings and other auxiliary ontologies.</li>
<li><strong>BERT synonym classifier</strong> training on synonym and non-synonym samples in text semantics corpora.</li>
<li><strong>Sub-word Inverted Index</strong> construction from the tokenised class annotations for candidate selection in mapping prediction.</li>
<li><strong>Mapping Predictor</strong> which integrates a simple edit distance-based string matching module and the fine-tuned BERT synonym classifier for mapping scoring. For each source ontology class, narrow down
target class candidates using the sub-word inverted index, apply string matching for "easy" mappings
and then apply BERT matching.</li>
<li><strong>Mapping Refiner</strong> which consists of the mapping extension and mapping repair modules. Mapping extension is an iterative process based on the <em>locality principle</em>. Mapping repair utilises the LogMap's debugger. </li>
</ul>
<p><span class="arithmatex">\(\textsf{BERTMapLt}\)</span> is a light-weight version of <span class="arithmatex">\(\textsf{BERTMap}\)</span> <em>without</em> the BERT module and mapping refiner.</p>
<p>See the tutorial for <span class="arithmatex">\(\textsf{BERTMap}\)</span> <a href="/pages/bertmap">here</a>.</p>


<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="deeponto.align.bertmap.pipeline.BERTMapPipeline" class="doc doc-heading">
        <code>BERTMapPipeline</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Class for the whole ontology alignment pipeline of <span class="arithmatex">\(\textsf{BERTMap}\)</span> and <span class="arithmatex">\(\textsf{BERTMapLt}\)</span> models.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Parameters related to BERT training are <code>None</code> by default. They will be constructed for
<span class="arithmatex">\(\textsf{BERTMap}\)</span> and stay as <code>None</code> for <span class="arithmatex">\(\textsf{BERTMapLt}\)</span>.</p>
</div>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><span title="yacs.config.CfgNode">CfgNode</span></code>
          </td>
          <td><p>The configuration for BERTMap or BERTMapLt.</p></td>
        </tr>
        <tr>
          <td><code>name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the model, either <code>bertmap</code> or <code>bertmaplt</code>.</p></td>
        </tr>
        <tr>
          <td><code>output_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to the output directory.</p></td>
        </tr>
        <tr>
          <td><code>src_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The source ontology to be matched.</p></td>
        </tr>
        <tr>
          <td><code>tgt_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The target ontology to be matched.</p></td>
        </tr>
        <tr>
          <td><code>annotation_property_iris</code></td>
          <td>
                <code>List[str]</code>
          </td>
          <td><p>The annotation property IRIs used for extracting synonyms and nonsynonyms.</p></td>
        </tr>
        <tr>
          <td><code>src_annotation_index</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary that stores the <code>(class_iri, class_annotations)</code> pairs from <code>src_onto</code> according to <code>annotation_property_iris</code>.</p></td>
        </tr>
        <tr>
          <td><code>tgt_annotation_index</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary that stores the <code>(class_iri, class_annotations)</code> pairs from <code>tgt_onto</code> according to <code>annotation_property_iris</code>.</p></td>
        </tr>
        <tr>
          <td><code>known_mappings</code></td>
          <td>
                <code>List[<a class="autorefs autorefs-internal" title="deeponto.align.mapping.ReferenceMapping" href="../mapping/#deeponto.align.mapping.ReferenceMapping">ReferenceMapping</a>]</code>
          </td>
          <td><p>List of known mappings for constructing the <strong>cross-ontology corpus</strong>.</p></td>
        </tr>
        <tr>
          <td><code>auxliary_ontos</code></td>
          <td>
                <code>List[<a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a>]</code>
          </td>
          <td><p>List of auxiliary ontolgoies for constructing any <strong>auxiliary corpus</strong>.</p></td>
        </tr>
        <tr>
          <td><code>corpora</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary that stores the <code>summary</code> of built text semantics corpora and the sampled <code>synonyms</code> and <code>nonsynonyms</code>.</p></td>
        </tr>
        <tr>
          <td><code>finetune_data</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary that stores the <code>training</code> and <code>validation</code> splits of samples from <code>corpora</code>.</p></td>
        </tr>
        <tr>
          <td><code>bert</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier" href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier">BERTSynonymClassifier</a></code>
          </td>
          <td><p>A BERT model for synonym classification and mapping prediction.</p></td>
        </tr>
        <tr>
          <td><code>best_checkpoint</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to the best BERT checkpoint which will be loaded after training.</p></td>
        </tr>
        <tr>
          <td><code>mapping_predictor</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.align.bertmap.mapping_prediction.MappingPredictor" href="#deeponto.align.bertmap.mapping_prediction.MappingPredictor">MappingPredictor</a></code>
          </td>
          <td><p>The predictor function based on class annotations, used for <strong>global matching</strong> or <strong>mapping scoring</strong>.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>deeponto/align/bertmap/pipeline.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BERTMapPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for the whole ontology alignment pipeline of $\textsf{BERTMap}$ and $\textsf{BERTMapLt}$ models.</span>

<span class="sd">    !!! note</span>

<span class="sd">        Parameters related to BERT training are `None` by default. They will be constructed for</span>
<span class="sd">        $\textsf{BERTMap}$ and stay as `None` for $\textsf{BERTMapLt}$.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (CfgNode): The configuration for BERTMap or BERTMapLt.</span>
<span class="sd">        name (str): The name of the model, either `bertmap` or `bertmaplt`.</span>
<span class="sd">        output_path (str): The path to the output directory.</span>
<span class="sd">        src_onto (Ontology): The source ontology to be matched.</span>
<span class="sd">        tgt_onto (Ontology): The target ontology to be matched.</span>
<span class="sd">        annotation_property_iris (List[str]): The annotation property IRIs used for extracting synonyms and nonsynonyms.</span>
<span class="sd">        src_annotation_index (dict): A dictionary that stores the `(class_iri, class_annotations)` pairs from `src_onto` according to `annotation_property_iris`.</span>
<span class="sd">        tgt_annotation_index (dict): A dictionary that stores the `(class_iri, class_annotations)` pairs from `tgt_onto` according to `annotation_property_iris`.</span>
<span class="sd">        known_mappings (List[ReferenceMapping], optional): List of known mappings for constructing the **cross-ontology corpus**.</span>
<span class="sd">        auxliary_ontos (List[Ontology], optional): List of auxiliary ontolgoies for constructing any **auxiliary corpus**.</span>
<span class="sd">        corpora (dict, optional): A dictionary that stores the `summary` of built text semantics corpora and the sampled `synonyms` and `nonsynonyms`.</span>
<span class="sd">        finetune_data (dict, optional): A dictionary that stores the `training` and `validation` splits of samples from `corpora`.</span>
<span class="sd">        bert (BERTSynonymClassifier, optional): A BERT model for synonym classification and mapping prediction.</span>
<span class="sd">        best_checkpoint (str, optional): The path to the best BERT checkpoint which will be loaded after training.</span>
<span class="sd">        mapping_predictor (MappingPredictor): The predictor function based on class annotations, used for **global matching** or **mapping scoring**.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span> <span class="n">tgt_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">CfgNode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the BERTMap or BERTMapLt model.</span>

<span class="sd">        Args:</span>
<span class="sd">            src_onto (Ontology): The source ontology for alignment.</span>
<span class="sd">            tgt_onto (Ontology): The target ontology for alignment.</span>
<span class="sd">            config (CfgNode): The configuration for BERTMap or BERTMapLt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load the configuration and confirm model name is valid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">MODEL_OPTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`model` </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in the config file is not one of the supported.&quot;</span><span class="p">)</span>

        <span class="c1"># create the output directory, e.g., experiments/bertmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>

        <span class="c1"># create logger and progress manager (hidden attribute) </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span> <span class="o">=</span> <span class="n">enlighten</span><span class="o">.</span><span class="n">get_manager</span><span class="p">()</span>

        <span class="c1"># ontology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span> <span class="o">=</span> <span class="n">src_onto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span> <span class="o">=</span> <span class="n">tgt_onto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">annotation_property_iris</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load the following configurations:</span><span class="se">\n</span><span class="si">{</span><span class="n">FileUtils</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Save the configuration file at </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_bertmap_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>

        <span class="c1"># build the annotation thesaurus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">build_annotation_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">build_annotation_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span><span class="p">)</span>

        <span class="c1"># provided mappings if any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">known_mappings</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span> <span class="o">=</span> <span class="n">ReferenceMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span><span class="p">)</span>

        <span class="c1"># auxiliary ontologies if any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">auxiliary_ontos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ontology</span><span class="p">(</span><span class="n">ao</span><span class="p">)</span> <span class="k">for</span> <span class="n">ao</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="c1"># load or construct the corpora</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corpora_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;text-semantics.corpora.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corpora</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_text_semantics_corpora</span><span class="p">()</span>

        <span class="c1"># load or construct fine-tune data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finetune_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;fine-tune.data.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finetune_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_finetune_data</span><span class="p">()</span>

        <span class="c1"># load the bert model and train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">bert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_pretrained_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">pretrained_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;bert&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_resume_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">resume_training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bertmap&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_bert_synonym_classifier</span><span class="p">()</span>
            <span class="c1"># train if the loaded classifier is not in eval mode</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">eval_mode</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Data statistics:</span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">FileUtils</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">data_stat</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_resume_training</span><span class="p">)</span>
                <span class="c1"># turn on eval mode after training</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="c1"># NOTE potential redundancy here: after training, load the best checkpoint</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_best_checkpoint</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No best checkpoint found for the BERT synonym classifier model.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fine-tuning finished, found best checkpoint at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No training needed; skip BERT fine-tuning.&quot;</span><span class="p">)</span>

        <span class="c1"># pretty progress bar tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">status_bar</span><span class="p">(</span>
            <span class="n">status_format</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;Global Matching</span><span class="si">{fill}</span><span class="s1">Stage: </span><span class="si">{demo}{fill}{elapsed}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;bold_underline_bright_white_on_lightslategray&#39;</span><span class="p">,</span>
            <span class="n">justify</span><span class="o">=</span><span class="n">enlighten</span><span class="o">.</span><span class="n">Justify</span><span class="o">.</span><span class="n">CENTER</span><span class="p">,</span> <span class="n">demo</span><span class="o">=</span><span class="s1">&#39;Initializing&#39;</span><span class="p">,</span>
            <span class="n">autorefresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>

        <span class="c1"># mapping predictions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">global_matching</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span> <span class="o">=</span> <span class="n">MappingPredictor</span><span class="p">(</span>
            <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span>
            <span class="n">tokenizer_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">pretrained_path</span><span class="p">,</span>
            <span class="n">src_annotation_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">,</span>
            <span class="n">tgt_annotation_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">,</span>
            <span class="n">bert_synonym_classifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="p">,</span>
            <span class="n">num_raw_candidates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span><span class="o">.</span><span class="n">num_raw_candidates</span><span class="p">,</span>
            <span class="n">num_best_predictions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">,</span>
            <span class="n">batch_size_for_prediction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">batch_size_for_prediction</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">enlighten_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="p">,</span>
            <span class="n">enlighten_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_refiner</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># if global matching is disabled (potentially used for class pair scoring)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">global_matching</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">mapping_prediction</span><span class="p">()</span>  <span class="c1"># mapping prediction</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bertmap&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapping_refiner</span> <span class="o">=</span> <span class="n">MappingRefiner</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span>
                    <span class="n">src_onto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="p">,</span>
                    <span class="n">tgt_onto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="p">,</span>
                    <span class="n">mapping_predictor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="p">,</span>
                    <span class="n">mapping_extension_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span><span class="o">.</span><span class="n">mapping_extension_threshold</span><span class="p">,</span>
                    <span class="n">mapping_filtered_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span><span class="o">.</span><span class="n">mapping_filtered_threshold</span><span class="p">,</span>
                    <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                    <span class="n">enlighten_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="p">,</span>
                    <span class="n">enlighten_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapping_refiner</span><span class="o">.</span><span class="n">mapping_extension</span><span class="p">()</span>  <span class="c1"># mapping extension</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapping_refiner</span><span class="o">.</span><span class="n">mapping_repair</span><span class="p">()</span>  <span class="c1"># mapping repair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Finished&quot;</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Skipped&quot;</span><span class="p">)</span>  

        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># class pair scoring is invoked outside</span>

    <span class="k">def</span> <span class="nf">load_or_construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">construct_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load existing data or construct a new one.</span>

<span class="sd">        An auxlirary function that checks the existence of a data file and loads it if it exists.</span>
<span class="sd">        Otherwise, construct new data with the input `construct_func` which is supported generate</span>
<span class="sd">        a local data file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load existing </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Construct new </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s2"> and save at </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">construct_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># load the data file that is supposed to be saved locally</span>
        <span class="k">return</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_text_semantics_corpora</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load or construct text semantics corpora.</span>

<span class="sd">        See [`TextSemanticsCorpora`][deeponto.align.bertmap.text_semantics.TextSemanticsCorpora].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_name</span> <span class="o">=</span> <span class="s2">&quot;text semantics corpora&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bertmap&quot;</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">construct</span><span class="p">():</span>
                <span class="n">corpora</span> <span class="o">=</span> <span class="n">TextSemanticsCorpora</span><span class="p">(</span>
                    <span class="n">src_onto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="p">,</span>
                    <span class="n">tgt_onto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="p">,</span>
                    <span class="n">annotation_property_iris</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span><span class="p">,</span>
                    <span class="n">class_mappings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span><span class="p">,</span>
                    <span class="n">auxiliary_ontos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">corpora</span><span class="p">))</span>
                <span class="n">corpora</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_or_construct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corpora_path</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">construct</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No training needed; skip the construction of </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">load_finetune_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Load or construct fine-tuning data from text semantics corpora.</span>

<span class="sd">        Steps of constructing fine-tuning data from text semantics:</span>

<span class="sd">        1. Mix synonym and nonsynonym data.</span>
<span class="sd">        2. Randomly sample 90% as training samples and 10% as validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_name</span> <span class="o">=</span> <span class="s2">&quot;fine-tuning data&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bertmap&quot;</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">construct</span><span class="p">():</span>
                <span class="n">finetune_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpora</span><span class="p">[</span><span class="s2">&quot;synonyms&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpora</span><span class="p">[</span><span class="s2">&quot;nonsynonyms&quot;</span><span class="p">]</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
                <span class="n">split_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>  <span class="c1"># split at 90%</span>
                <span class="n">finetune_data</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:</span><span class="n">split_index</span><span class="p">]</span>
                <span class="n">finetune_data</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]</span>
                <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">finetune_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finetune_data_path</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_or_construct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finetune_data_path</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">construct</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No training needed; skip the construction of </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">load_bert_synonym_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the BERT model from a pre-trained or a local checkpoint.</span>

<span class="sd">        - If loaded from pre-trained, it means to start training from a pre-trained model such as `bert-uncased`.</span>
<span class="sd">        - If loaded from local, turn on the `eval` mode for mapping predictions.</span>
<span class="sd">        - If `self.bert_resume_training` is `True`, it will be loaded from the latest saved checkpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_best_checkpoint</span><span class="p">()</span>  <span class="c1"># load the best checkpoint or nothing</span>
        <span class="n">eval_mode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># if no checkpoint has been found, start training from scratch OR resume training</span>
        <span class="c1"># no point to load the best checkpoint if resume training (will automatically search for the latest checkpoint)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkpoint</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_resume_training</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_pretrained_path</span>
            <span class="n">eval_mode</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># since it is for training now</span>

        <span class="k">return</span> <span class="n">BERTSynonymClassifier</span><span class="p">(</span>
            <span class="n">loaded_path</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
            <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">,</span>
            <span class="n">eval_mode</span><span class="o">=</span><span class="n">eval_mode</span><span class="p">,</span>
            <span class="n">max_length_for_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">max_length_for_input</span><span class="p">,</span>
            <span class="n">num_epochs_for_training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">num_epochs_for_training</span><span class="p">,</span>
            <span class="n">batch_size_for_training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">batch_size_for_training</span><span class="p">,</span>
            <span class="n">batch_size_for_prediction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">batch_size_for_prediction</span><span class="p">,</span>
            <span class="n">training_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">finetune_data</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">],</span>
            <span class="n">validation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">finetune_data</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_best_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the best checkpoint by searching for trainer states in each checkpoint file.&quot;&quot;&quot;</span>
        <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">):</span>
                <span class="c1"># load trainer states from each checkpoint file</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">):</span>
                    <span class="n">trainer_state</span> <span class="o">=</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;trainer_state.json&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">checkpoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trainer_state</span><span class="p">[</span><span class="s2">&quot;best_model_checkpoint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># find the latest best checkpoint</span>
                    <span class="k">if</span> <span class="n">checkpoint</span> <span class="o">&gt;</span> <span class="n">best_checkpoint</span><span class="p">:</span>
                        <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span>

        <span class="k">if</span> <span class="n">best_checkpoint</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;checkpoint-</span><span class="si">{</span><span class="n">best_checkpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">best_checkpoint</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_bertmap_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the BERTMap configuration in `.yaml`. If the file</span>
<span class="sd">        is not provided, use the default configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file</span><span class="p">:</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG_FILE</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Use the default configuration at </span><span class="si">{</span><span class="n">DEFAULT_CONFIG_FILE</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>  
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Configuration file should be in `yaml` format.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CfgNode</span><span class="p">(</span><span class="n">FileUtils</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_bertmap_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">CfgNode</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the BERTMap configuration in `.yaml`.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.pipeline.BERTMapPipeline.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">src_onto</span><span class="p">,</span> <span class="n">tgt_onto</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the BERTMap or BERTMapLt model.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The source ontology for alignment.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The target ontology for alignment.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><span title="yacs.config.CfgNode">CfgNode</span></code>
          </td>
          <td><p>The configuration for BERTMap or BERTMapLt.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/pipeline.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span> <span class="n">tgt_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">CfgNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the BERTMap or BERTMapLt model.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_onto (Ontology): The source ontology for alignment.</span>
<span class="sd">        tgt_onto (Ontology): The target ontology for alignment.</span>
<span class="sd">        config (CfgNode): The configuration for BERTMap or BERTMapLt.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load the configuration and confirm model name is valid</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">MODEL_OPTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`model` </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in the config file is not one of the supported.&quot;</span><span class="p">)</span>

    <span class="c1"># create the output directory, e.g., experiments/bertmap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>

    <span class="c1"># create logger and progress manager (hidden attribute) </span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span> <span class="o">=</span> <span class="n">enlighten</span><span class="o">.</span><span class="n">get_manager</span><span class="p">()</span>

    <span class="c1"># ontology</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span> <span class="o">=</span> <span class="n">src_onto</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span> <span class="o">=</span> <span class="n">tgt_onto</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">annotation_property_iris</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load the following configurations:</span><span class="se">\n</span><span class="si">{</span><span class="n">FileUtils</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Save the configuration file at </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_bertmap_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>

    <span class="c1"># build the annotation thesaurus</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">build_annotation_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">build_annotation_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span><span class="p">)</span>

    <span class="c1"># provided mappings if any</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">known_mappings</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span> <span class="o">=</span> <span class="n">ReferenceMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span><span class="p">)</span>

    <span class="c1"># auxiliary ontologies if any</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">auxiliary_ontos</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ontology</span><span class="p">(</span><span class="n">ao</span><span class="p">)</span> <span class="k">for</span> <span class="n">ao</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
    <span class="c1"># load or construct the corpora</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">corpora_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;text-semantics.corpora.json&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">corpora</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_text_semantics_corpora</span><span class="p">()</span>

    <span class="c1"># load or construct fine-tune data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">finetune_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;fine-tune.data.json&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">finetune_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_finetune_data</span><span class="p">()</span>

    <span class="c1"># load the bert model and train</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">bert</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bert_pretrained_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">pretrained_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;bert&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bert_resume_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">resume_training</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bertmap&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_bert_synonym_classifier</span><span class="p">()</span>
        <span class="c1"># train if the loaded classifier is not in eval mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">eval_mode</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Data statistics:</span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                </span><span class="si">{</span><span class="n">FileUtils</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">data_stat</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_resume_training</span><span class="p">)</span>
            <span class="c1"># turn on eval mode after training</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># NOTE potential redundancy here: after training, load the best checkpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_best_checkpoint</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No best checkpoint found for the BERT synonym classifier model.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fine-tuning finished, found best checkpoint at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No training needed; skip BERT fine-tuning.&quot;</span><span class="p">)</span>

    <span class="c1"># pretty progress bar tracking</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">status_bar</span><span class="p">(</span>
        <span class="n">status_format</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;Global Matching</span><span class="si">{fill}</span><span class="s1">Stage: </span><span class="si">{demo}{fill}{elapsed}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;bold_underline_bright_white_on_lightslategray&#39;</span><span class="p">,</span>
        <span class="n">justify</span><span class="o">=</span><span class="n">enlighten</span><span class="o">.</span><span class="n">Justify</span><span class="o">.</span><span class="n">CENTER</span><span class="p">,</span> <span class="n">demo</span><span class="o">=</span><span class="s1">&#39;Initializing&#39;</span><span class="p">,</span>
        <span class="n">autorefresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>

    <span class="c1"># mapping predictions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">global_matching</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span> <span class="o">=</span> <span class="n">MappingPredictor</span><span class="p">(</span>
        <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span>
        <span class="n">tokenizer_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">pretrained_path</span><span class="p">,</span>
        <span class="n">src_annotation_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">,</span>
        <span class="n">tgt_annotation_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">,</span>
        <span class="n">bert_synonym_classifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="p">,</span>
        <span class="n">num_raw_candidates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span><span class="o">.</span><span class="n">num_raw_candidates</span><span class="p">,</span>
        <span class="n">num_best_predictions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">,</span>
        <span class="n">batch_size_for_prediction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">batch_size_for_prediction</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="n">enlighten_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="p">,</span>
        <span class="n">enlighten_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mapping_refiner</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># if global matching is disabled (potentially used for class pair scoring)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">global_matching</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">mapping_prediction</span><span class="p">()</span>  <span class="c1"># mapping prediction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bertmap&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_refiner</span> <span class="o">=</span> <span class="n">MappingRefiner</span><span class="p">(</span>
                <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span>
                <span class="n">src_onto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="p">,</span>
                <span class="n">tgt_onto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="p">,</span>
                <span class="n">mapping_predictor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="p">,</span>
                <span class="n">mapping_extension_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span><span class="o">.</span><span class="n">mapping_extension_threshold</span><span class="p">,</span>
                <span class="n">mapping_filtered_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_matching_config</span><span class="o">.</span><span class="n">mapping_filtered_threshold</span><span class="p">,</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                <span class="n">enlighten_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="p">,</span>
                <span class="n">enlighten_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_refiner</span><span class="o">.</span><span class="n">mapping_extension</span><span class="p">()</span>  <span class="c1"># mapping extension</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_refiner</span><span class="o">.</span><span class="n">mapping_repair</span><span class="p">()</span>  <span class="c1"># mapping repair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Finished&quot;</span><span class="p">)</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Skipped&quot;</span><span class="p">)</span>  

    <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.pipeline.BERTMapPipeline.load_or_construct" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_or_construct</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">construct_func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load existing data or construct a new one.</p>
<p>An auxlirary function that checks the existence of a data file and loads it if it exists.
Otherwise, construct new data with the input <code>construct_func</code> which is supported generate
a local data file.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/pipeline.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_or_construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">construct_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load existing data or construct a new one.</span>

<span class="sd">    An auxlirary function that checks the existence of a data file and loads it if it exists.</span>
<span class="sd">    Otherwise, construct new data with the input `construct_func` which is supported generate</span>
<span class="sd">    a local data file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load existing </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Construct new </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s2"> and save at </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">construct_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># load the data file that is supposed to be saved locally</span>
    <span class="k">return</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.pipeline.BERTMapPipeline.load_text_semantics_corpora" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_text_semantics_corpora</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load or construct text semantics corpora.</p>
<p>See <a class="autorefs autorefs-internal" href="#deeponto.align.bertmap.text_semantics.TextSemanticsCorpora"><code>TextSemanticsCorpora</code></a>.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/pipeline.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_text_semantics_corpora</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load or construct text semantics corpora.</span>

<span class="sd">    See [`TextSemanticsCorpora`][deeponto.align.bertmap.text_semantics.TextSemanticsCorpora].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_name</span> <span class="o">=</span> <span class="s2">&quot;text semantics corpora&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bertmap&quot;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">construct</span><span class="p">():</span>
            <span class="n">corpora</span> <span class="o">=</span> <span class="n">TextSemanticsCorpora</span><span class="p">(</span>
                <span class="n">src_onto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="p">,</span>
                <span class="n">tgt_onto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="p">,</span>
                <span class="n">annotation_property_iris</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span><span class="p">,</span>
                <span class="n">class_mappings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_mappings</span><span class="p">,</span>
                <span class="n">auxiliary_ontos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">corpora</span><span class="p">))</span>
            <span class="n">corpora</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_or_construct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corpora_path</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">construct</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No training needed; skip the construction of </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.pipeline.BERTMapPipeline.load_finetune_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_finetune_data</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load or construct fine-tuning data from text semantics corpora.</p>
<p>Steps of constructing fine-tuning data from text semantics:</p>
<ol>
<li>Mix synonym and nonsynonym data.</li>
<li>Randomly sample 90% as training samples and 10% as validation.</li>
</ol>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/pipeline.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_finetune_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Load or construct fine-tuning data from text semantics corpora.</span>

<span class="sd">    Steps of constructing fine-tuning data from text semantics:</span>

<span class="sd">    1. Mix synonym and nonsynonym data.</span>
<span class="sd">    2. Randomly sample 90% as training samples and 10% as validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_name</span> <span class="o">=</span> <span class="s2">&quot;fine-tuning data&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bertmap&quot;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">construct</span><span class="p">():</span>
            <span class="n">finetune_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpora</span><span class="p">[</span><span class="s2">&quot;synonyms&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpora</span><span class="p">[</span><span class="s2">&quot;nonsynonyms&quot;</span><span class="p">]</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
            <span class="n">split_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>  <span class="c1"># split at 90%</span>
            <span class="n">finetune_data</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:</span><span class="n">split_index</span><span class="p">]</span>
            <span class="n">finetune_data</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]</span>
            <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">finetune_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finetune_data_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_or_construct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finetune_data_path</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">construct</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No training needed; skip the construction of </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.pipeline.BERTMapPipeline.load_bert_synonym_classifier" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_bert_synonym_classifier</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load the BERT model from a pre-trained or a local checkpoint.</p>
<ul>
<li>If loaded from pre-trained, it means to start training from a pre-trained model such as <code>bert-uncased</code>.</li>
<li>If loaded from local, turn on the <code>eval</code> mode for mapping predictions.</li>
<li>If <code>self.bert_resume_training</code> is <code>True</code>, it will be loaded from the latest saved checkpoint.</li>
</ul>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/pipeline.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_bert_synonym_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the BERT model from a pre-trained or a local checkpoint.</span>

<span class="sd">    - If loaded from pre-trained, it means to start training from a pre-trained model such as `bert-uncased`.</span>
<span class="sd">    - If loaded from local, turn on the `eval` mode for mapping predictions.</span>
<span class="sd">    - If `self.bert_resume_training` is `True`, it will be loaded from the latest saved checkpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_best_checkpoint</span><span class="p">()</span>  <span class="c1"># load the best checkpoint or nothing</span>
    <span class="n">eval_mode</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># if no checkpoint has been found, start training from scratch OR resume training</span>
    <span class="c1"># no point to load the best checkpoint if resume training (will automatically search for the latest checkpoint)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">checkpoint</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_resume_training</span><span class="p">:</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_pretrained_path</span>
        <span class="n">eval_mode</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># since it is for training now</span>

    <span class="k">return</span> <span class="n">BERTSynonymClassifier</span><span class="p">(</span>
        <span class="n">loaded_path</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
        <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">,</span>
        <span class="n">eval_mode</span><span class="o">=</span><span class="n">eval_mode</span><span class="p">,</span>
        <span class="n">max_length_for_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">max_length_for_input</span><span class="p">,</span>
        <span class="n">num_epochs_for_training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">num_epochs_for_training</span><span class="p">,</span>
        <span class="n">batch_size_for_training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">batch_size_for_training</span><span class="p">,</span>
        <span class="n">batch_size_for_prediction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span><span class="o">.</span><span class="n">batch_size_for_prediction</span><span class="p">,</span>
        <span class="n">training_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">finetune_data</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">],</span>
        <span class="n">validation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">finetune_data</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.pipeline.BERTMapPipeline.load_best_checkpoint" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_best_checkpoint</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Find the best checkpoint by searching for trainer states in each checkpoint file.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/pipeline.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_best_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the best checkpoint by searching for trainer states in each checkpoint file.&quot;&quot;&quot;</span>
    <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">):</span>
            <span class="c1"># load trainer states from each checkpoint file</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">):</span>
                <span class="n">trainer_state</span> <span class="o">=</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;trainer_state.json&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">checkpoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trainer_state</span><span class="p">[</span><span class="s2">&quot;best_model_checkpoint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># find the latest best checkpoint</span>
                <span class="k">if</span> <span class="n">checkpoint</span> <span class="o">&gt;</span> <span class="n">best_checkpoint</span><span class="p">:</span>
                    <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span>

    <span class="k">if</span> <span class="n">best_checkpoint</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_finetuned_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;checkpoint-</span><span class="si">{</span><span class="n">best_checkpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">best_checkpoint</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.pipeline.BERTMapPipeline.load_bertmap_config" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_bertmap_config</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load the BERTMap configuration in <code>.yaml</code>. If the file
is not provided, use the default configuration.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/pipeline.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">load_bertmap_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the BERTMap configuration in `.yaml`. If the file</span>
<span class="sd">    is not provided, use the default configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file</span><span class="p">:</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG_FILE</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Use the default configuration at </span><span class="si">{</span><span class="n">DEFAULT_CONFIG_FILE</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>  
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Configuration file should be in `yaml` format.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CfgNode</span><span class="p">(</span><span class="n">FileUtils</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.pipeline.BERTMapPipeline.save_bertmap_config" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save_bertmap_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_file</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Save the BERTMap configuration in <code>.yaml</code>.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/pipeline.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">save_bertmap_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">CfgNode</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the BERTMap configuration in `.yaml`.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="deeponto.align.bertmap.text_semantics.AnnotationThesaurus" class="doc doc-heading">
        <code>AnnotationThesaurus</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>A thesaurus class for synonyms and non-synonyms extracted from an ontology.</p>
<p>Some related definitions of arguements here:</p>
<ul>
<li>A <code>synonym_group</code> is a set of annotation phrases that are synonymous to each other;</li>
<li>The <code>transitivity</code> of synonyms means if A and B are synonymous and B and C are synonymous,
then A and C are synonymous. This is achieved by a connected graph-based algorithm.</li>
<li>A <code>synonym_pair</code> is a pair synonymous annotation phrase which can be extracted from
the cartesian product of a <code>synonym_group</code> and itself. NOTE that <strong>reflexivity</strong> and <strong>symmetry</strong>
are preserved meaning that <em>(i)</em> every phrase A is a synonym of itself and <em>(ii)</em> if (A, B) is
a synonym pair then (B, A) is a synonym pair, too.</li>
</ul>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>An ontology to construct the annotation thesaurus from.</p></td>
        </tr>
        <tr>
          <td><code>annotation_index</code></td>
          <td>
                <code>Dict[str, <span title="typing.Set">Set</span>[str]]</code>
          </td>
          <td><p>An index of the class annotations with <code>(class_iri, annotations)</code> pairs.</p></td>
        </tr>
        <tr>
          <td><code>annotation_property_iris</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>A list of annotation property IRIs used to extract the annotations.</p></td>
        </tr>
        <tr>
          <td><code>average_number_of_annotations_per_class</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The average number of (extracted) annotations per ontology class.</p></td>
        </tr>
        <tr>
          <td><code>apply_transitivity</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Apply synonym transitivity to merge synonym groups or not.</p></td>
        </tr>
        <tr>
          <td><code>synonym_groups</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Set">Set</span>[str]]</code>
          </td>
          <td><p>The list of synonym groups extracted from the ontology according to specified annotation properties.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AnnotationThesaurus</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A thesaurus class for synonyms and non-synonyms extracted from an ontology.</span>

<span class="sd">    Some related definitions of arguements here:</span>

<span class="sd">    - A `synonym_group` is a set of annotation phrases that are synonymous to each other;</span>
<span class="sd">    - The `transitivity` of synonyms means if A and B are synonymous and B and C are synonymous,</span>
<span class="sd">    then A and C are synonymous. This is achieved by a connected graph-based algorithm.</span>
<span class="sd">    - A `synonym_pair` is a pair synonymous annotation phrase which can be extracted from</span>
<span class="sd">    the cartesian product of a `synonym_group` and itself. NOTE that **reflexivity** and **symmetry**</span>
<span class="sd">    are preserved meaning that *(i)* every phrase A is a synonym of itself and *(ii)* if (A, B) is</span>
<span class="sd">    a synonym pair then (B, A) is a synonym pair, too.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        onto (Ontology): An ontology to construct the annotation thesaurus from.</span>
<span class="sd">        annotation_index (Dict[str, Set[str]]): An index of the class annotations with `(class_iri, annotations)` pairs.</span>
<span class="sd">        annotation_property_iris (List[str]): A list of annotation property IRIs used to extract the annotations.</span>
<span class="sd">        average_number_of_annotations_per_class (int): The average number of (extracted) annotations per ontology class.</span>
<span class="sd">        apply_transitivity (bool): Apply synonym transitivity to merge synonym groups or not.</span>
<span class="sd">        synonym_groups (List[Set[str]]): The list of synonym groups extracted from the ontology according to specified annotation properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span> <span class="n">annotation_property_iris</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">apply_transitivity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialise a thesaurus for ontology class annotations.</span>

<span class="sd">        Args:</span>
<span class="sd">            onto (Ontology): The input ontology to extract annotations from.</span>
<span class="sd">            annotation_property_iris (List[str]): Specify which annotation properties to be used.</span>
<span class="sd">            apply_transitivity (bool, optional): Apply synonym transitivity to merge synonym groups or not. Defaults to `False`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">onto</span> <span class="o">=</span> <span class="n">onto</span>
        <span class="c1"># build the annotation index to extract synonyms from `onto`</span>
        <span class="c1"># the input property iris may not exist in this ontology</span>
        <span class="c1"># the output property iris will be truncated to the existing ones</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">build_annotation_index</span><span class="p">(</span>
            <span class="n">annotation_property_iris</span><span class="o">=</span><span class="n">annotation_property_iris</span><span class="p">,</span>
            <span class="n">entity_type</span><span class="o">=</span><span class="s2">&quot;Classes&quot;</span><span class="p">,</span>
            <span class="n">apply_lowercasing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span> <span class="o">=</span> <span class="n">iris</span>
        <span class="n">total_number_of_annotations</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average_number_of_annotations_per_class</span> <span class="o">=</span> <span class="n">total_number_of_annotations</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">)</span>

        <span class="c1"># synonym groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_transitivity</span> <span class="o">=</span> <span class="n">apply_transitivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_transitivity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_synonym_groups_by_transitivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span><span class="p">)</span>

        <span class="c1"># summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;ontology&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">],</span>
                <span class="s2">&quot;average_number_of_annotations_per_class&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_number_of_annotations_per_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="s2">&quot;number_of_synonym_groups&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="p">)</span>  <span class="c1"># the info of ontology is updated upon calling its __str__ method</span>
        <span class="k">return</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_synonym_pairs</span><span class="p">(</span><span class="n">synonym_group</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">remove_duplicates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get synonym pairs from a synonym group through a cartesian product.</span>

<span class="sd">        Args:</span>
<span class="sd">            synonym_group (Set[str]): A set of annotation phrases that are synonymous to each other.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[Tuple[str, str]]): A list of synonym pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">synonym_group</span><span class="p">,</span> <span class="n">synonym_group</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">remove_duplicates</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">synonym_pairs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">merge_synonym_groups_by_transitivity</span><span class="p">(</span><span class="n">synonym_groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Merge synonym groups by transitivity.</span>

<span class="sd">        Synonym groups that share a common annotation phrase will be merged. NOTE that for</span>
<span class="sd">        multiple ontologies, we can merge their synonym groups by first concatenating them</span>
<span class="sd">        then use this function.</span>

<span class="sd">        !!! note</span>

<span class="sd">            In $\textsf{BERTMap}$ experiments we have considered this as a data augmentation approach</span>
<span class="sd">            but it does not bring a significant performance improvement. However, if the</span>
<span class="sd">            overall number of annotations is not large enough then this could be a good option.</span>

<span class="sd">        Args:</span>
<span class="sd">            *synonym_groups (List[Set[str]]): A sequence of synonym groups to be merged.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[Set[str]]): A list of merged synonym groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">synonym_group</span> <span class="ow">in</span> <span class="n">synonym_groups</span><span class="p">:</span>
            <span class="c1"># gather synonym pairs from the self-product of a synonym group</span>
            <span class="n">synonym_pairs</span> <span class="o">+=</span> <span class="n">AnnotationThesaurus</span><span class="o">.</span><span class="n">get_synonym_pairs</span><span class="p">(</span><span class="n">synonym_group</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">)</span>
        <span class="n">merged_grouped_synonyms</span> <span class="o">=</span> <span class="n">AnnotationThesaurus</span><span class="o">.</span><span class="n">connected_labels</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merged_grouped_synonyms</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">connected_annotations</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a graph for adjacency among the class annotations (labels) such that</span>
<span class="sd">        the **transitivity** of synonyms is ensured.</span>

<span class="sd">        Auxiliary function for [`merge_synonym_groups_by_transitivity`][deeponto.align.bertmap.text_semantics.AnnotationThesaurus.merge_synonym_groups_by_transitivity].</span>

<span class="sd">        Args:</span>
<span class="sd">            synonym_pairs (List[Tuple[str, str]]): List of pairs of phrases that are synonymous.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[Set[str]]): A list of synonym groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">)</span>
        <span class="c1"># nx.draw(G, with_labels = True)</span>
        <span class="n">connected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">graph</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">connected</span>

    <span class="k">def</span> <span class="nf">synonym_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample synonym pairs from a list of synonym groups extracted from the input ontology.</span>

<span class="sd">        According to the $\textsf{BERTMap}$ paper, **synonyms** are defined as label pairs that belong</span>
<span class="sd">        to the same ontology class.</span>

<span class="sd">        NOTE this has been validated for getting the same results as in the original $\textsf{BERTMap}$ repository.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_samples (int, optional): The (maximum) number of **unique** samples extracted. Defaults to `None`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[Tuple[str, str]]): A list of unique synonym pair samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">synonym_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">synonym_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span><span class="p">:</span>
            <span class="c1"># do not remove duplicates in the loop to save time</span>
            <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_synonym_pairs</span><span class="p">(</span><span class="n">synonym_group</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">synonym_pool</span> <span class="o">+=</span> <span class="n">synonym_pairs</span>
        <span class="c1"># remove duplicates afer the loop</span>
        <span class="n">synonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">synonym_pool</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">num_samples</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_samples</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">synonym_pool</span><span class="p">)):</span>
            <span class="c1"># print(&quot;Return all synonym pairs without downsampling.&quot;)</span>
            <span class="k">return</span> <span class="n">synonym_pool</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">synonym_pool</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">soft_nonsynonym_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample **soft** non-synonyms from a list of synonym groups extracted from the input ontology.</span>

<span class="sd">        According to the $\textsf{BERTMap}$ paper, **soft non-synonyms** are defined as label pairs</span>
<span class="sd">        from two *different* synonym groups that are **randomly** selected.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_samples (int): The (maximum) number of **unique** samples extracted; this is</span>
<span class="sd">                required **unlike for synonym sampling** because the non-synonym pool is **significantly</span>
<span class="sd">                larger** (considering random combinations of different synonym groups).</span>
<span class="sd">            max_iter (int): The maximum number of iterations for conducting sampling. Defaults to `5`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[Tuple[str, str]]): A list of unique (soft) non-synonym pair samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nonsyonym_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># randomly select disjoint synonym group pairs from all</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
            <span class="n">left_synonym_group</span><span class="p">,</span> <span class="n">right_synonym_group</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="c1"># randomly choose one label from a synonym group</span>
            <span class="n">left_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">left_synonym_group</span><span class="p">))</span>
            <span class="n">right_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">right_synonym_group</span><span class="p">))</span>
            <span class="n">nonsyonym_pool</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_label</span><span class="p">,</span> <span class="n">right_label</span><span class="p">))</span>

        <span class="c1"># DataUtils.uniqify is too slow so we should avoid operating it too often</span>
        <span class="n">nonsyonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsyonym_pool</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsyonym_pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_samples</span> <span class="ow">and</span> <span class="n">max_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># reduce the iteration to prevent exhausting loop</span>
            <span class="n">nonsyonym_pool</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soft_nonsynonym_sampling</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsyonym_pool</span><span class="p">),</span> <span class="n">max_iter</span><span class="p">)</span>
            <span class="n">nonsyonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsyonym_pool</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nonsyonym_pool</span>

    <span class="k">def</span> <span class="nf">weighted_random_choices_of_sibling_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Randomly (weighted) select a number of sibling class groups.</span>

<span class="sd">        The weights are computed according to the sizes of the sibling class groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">sibling_class_groups</span><span class="p">]</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>  <span class="c1"># normalised</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">sibling_class_groups</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hard_nonsynonym_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample **hard** non-synonyms from sibling classes of the input ontology.</span>

<span class="sd">        According to the $\textsf{BERTMap}$ paper, **hard non-synonyms** are defined as label pairs</span>
<span class="sd">        that belong to two **disjoint** ontology classes. For practical reason, the condition</span>
<span class="sd">        is eased to two **sibling** ontology classes.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_samples (int): The (maximum) number of **unique** samples extracted; this is</span>
<span class="sd">                required **unlike for synonym sampling** because the non-synonym pool is **significantly</span>
<span class="sd">                larger** (considering random combinations of different synonym groups).</span>
<span class="sd">            max_iter (int): The maximum number of iterations for conducting sampling. Defaults to `5`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[Tuple[str, str]]): A list of unique (hard) non-synonym pair samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># intialise the sibling class groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">sibling_class_groups</span>

        <span class="c1"># flatten the disjointness groups into all pairs of hard neagtives</span>
        <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># randomly (weighted) select a number of sibling class groups with replacement</span>
        <span class="n">sibling_class_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_random_choices_of_sibling_groups</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sibling_class_group</span> <span class="ow">in</span> <span class="n">sibling_class_groups</span><span class="p">:</span>
            <span class="c1"># random select two sibling classes; no weights this time</span>
            <span class="n">left_class_iri</span><span class="p">,</span> <span class="n">right_class_iri</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sibling_class_group</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="c1"># random select a label for each of them</span>
            <span class="n">left_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">left_class_iri</span><span class="p">]))</span>
            <span class="n">right_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">right_class_iri</span><span class="p">]))</span>
            <span class="c1"># add the label pair to the pool</span>
            <span class="n">nonsynonym_pool</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_label</span><span class="p">,</span> <span class="n">right_label</span><span class="p">))</span>

        <span class="c1"># DataUtils.uniqify is too slow so we should avoid operating it too often</span>
        <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_samples</span> <span class="ow">and</span> <span class="n">max_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># reduce the iteration to prevent exhausting loop</span>
            <span class="n">nonsynonym_pool</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_nonsynonym_sampling</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">),</span> <span class="n">max_iter</span><span class="p">)</span>
            <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nonsynonym_pool</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.AnnotationThesaurus.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">onto</span><span class="p">,</span> <span class="n">annotation_property_iris</span><span class="p">,</span> <span class="n">apply_transitivity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialise a thesaurus for ontology class annotations.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The input ontology to extract annotations from.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_property_iris</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>Specify which annotation properties to be used.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>apply_transitivity</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Apply synonym transitivity to merge synonym groups or not. Defaults to <code>False</code>.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span> <span class="n">annotation_property_iris</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">apply_transitivity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialise a thesaurus for ontology class annotations.</span>

<span class="sd">    Args:</span>
<span class="sd">        onto (Ontology): The input ontology to extract annotations from.</span>
<span class="sd">        annotation_property_iris (List[str]): Specify which annotation properties to be used.</span>
<span class="sd">        apply_transitivity (bool, optional): Apply synonym transitivity to merge synonym groups or not. Defaults to `False`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">onto</span> <span class="o">=</span> <span class="n">onto</span>
    <span class="c1"># build the annotation index to extract synonyms from `onto`</span>
    <span class="c1"># the input property iris may not exist in this ontology</span>
    <span class="c1"># the output property iris will be truncated to the existing ones</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">build_annotation_index</span><span class="p">(</span>
        <span class="n">annotation_property_iris</span><span class="o">=</span><span class="n">annotation_property_iris</span><span class="p">,</span>
        <span class="n">entity_type</span><span class="o">=</span><span class="s2">&quot;Classes&quot;</span><span class="p">,</span>
        <span class="n">apply_lowercasing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">annotation_property_iris</span> <span class="o">=</span> <span class="n">iris</span>
    <span class="n">total_number_of_annotations</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">average_number_of_annotations_per_class</span> <span class="o">=</span> <span class="n">total_number_of_annotations</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">)</span>

    <span class="c1"># synonym groups</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">apply_transitivity</span> <span class="o">=</span> <span class="n">apply_transitivity</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_transitivity</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_synonym_groups_by_transitivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span><span class="p">)</span>

    <span class="c1"># summary</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ontology&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">],</span>
            <span class="s2">&quot;average_number_of_annotations_per_class&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_number_of_annotations_per_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="s2">&quot;number_of_synonym_groups&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.AnnotationThesaurus.get_synonym_pairs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_synonym_pairs</span><span class="p">(</span><span class="n">synonym_group</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get synonym pairs from a synonym group through a cartesian product.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>synonym_group</code></td>
          <td>
                <code><span title="typing.Set">Set</span>[str]</code>
          </td>
          <td><p>A set of annotation phrases that are synonymous to each other.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[str, str]]</code>
          </td>
          <td><p>A list of synonym pairs.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_synonym_pairs</span><span class="p">(</span><span class="n">synonym_group</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">remove_duplicates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get synonym pairs from a synonym group through a cartesian product.</span>

<span class="sd">    Args:</span>
<span class="sd">        synonym_group (Set[str]): A set of annotation phrases that are synonymous to each other.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[Tuple[str, str]]): A list of synonym pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">synonym_group</span><span class="p">,</span> <span class="n">synonym_group</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">remove_duplicates</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">synonym_pairs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.AnnotationThesaurus.merge_synonym_groups_by_transitivity" class="doc doc-heading">
<code class="highlight language-python"><span class="n">merge_synonym_groups_by_transitivity</span><span class="p">(</span><span class="n">synonym_groups</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Merge synonym groups by transitivity.</p>
<p>Synonym groups that share a common annotation phrase will be merged. NOTE that for
multiple ontologies, we can merge their synonym groups by first concatenating them
then use this function.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In <span class="arithmatex">\(\textsf{BERTMap}\)</span> experiments we have considered this as a data augmentation approach
but it does not bring a significant performance improvement. However, if the
overall number of annotations is not large enough then this could be a good option.</p>
</div>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>*synonym_groups</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Set">Set</span>[str]]</code>
          </td>
          <td><p>A sequence of synonym groups to be merged.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Set">Set</span>[str]]</code>
          </td>
          <td><p>A list of merged synonym groups.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">merge_synonym_groups_by_transitivity</span><span class="p">(</span><span class="n">synonym_groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Merge synonym groups by transitivity.</span>

<span class="sd">    Synonym groups that share a common annotation phrase will be merged. NOTE that for</span>
<span class="sd">    multiple ontologies, we can merge their synonym groups by first concatenating them</span>
<span class="sd">    then use this function.</span>

<span class="sd">    !!! note</span>

<span class="sd">        In $\textsf{BERTMap}$ experiments we have considered this as a data augmentation approach</span>
<span class="sd">        but it does not bring a significant performance improvement. However, if the</span>
<span class="sd">        overall number of annotations is not large enough then this could be a good option.</span>

<span class="sd">    Args:</span>
<span class="sd">        *synonym_groups (List[Set[str]]): A sequence of synonym groups to be merged.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[Set[str]]): A list of merged synonym groups.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">synonym_group</span> <span class="ow">in</span> <span class="n">synonym_groups</span><span class="p">:</span>
        <span class="c1"># gather synonym pairs from the self-product of a synonym group</span>
        <span class="n">synonym_pairs</span> <span class="o">+=</span> <span class="n">AnnotationThesaurus</span><span class="o">.</span><span class="n">get_synonym_pairs</span><span class="p">(</span><span class="n">synonym_group</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">)</span>
    <span class="n">merged_grouped_synonyms</span> <span class="o">=</span> <span class="n">AnnotationThesaurus</span><span class="o">.</span><span class="n">connected_labels</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged_grouped_synonyms</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.AnnotationThesaurus.connected_annotations" class="doc doc-heading">
<code class="highlight language-python"><span class="n">connected_annotations</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build a graph for adjacency among the class annotations (labels) such that
the <strong>transitivity</strong> of synonyms is ensured.</p>
<p>Auxiliary function for <a class="autorefs autorefs-internal" href="#deeponto.align.bertmap.text_semantics.AnnotationThesaurus.merge_synonym_groups_by_transitivity"><code>merge_synonym_groups_by_transitivity</code></a>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>synonym_pairs</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[str, str]]</code>
          </td>
          <td><p>List of pairs of phrases that are synonymous.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Set">Set</span>[str]]</code>
          </td>
          <td><p>A list of synonym groups.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">connected_annotations</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a graph for adjacency among the class annotations (labels) such that</span>
<span class="sd">    the **transitivity** of synonyms is ensured.</span>

<span class="sd">    Auxiliary function for [`merge_synonym_groups_by_transitivity`][deeponto.align.bertmap.text_semantics.AnnotationThesaurus.merge_synonym_groups_by_transitivity].</span>

<span class="sd">    Args:</span>
<span class="sd">        synonym_pairs (List[Tuple[str, str]]): List of pairs of phrases that are synonymous.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[Set[str]]): A list of synonym groups.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">synonym_pairs</span><span class="p">)</span>
    <span class="c1"># nx.draw(G, with_labels = True)</span>
    <span class="n">connected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">graph</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">connected</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.AnnotationThesaurus.synonym_sampling" class="doc doc-heading">
<code class="highlight language-python"><span class="n">synonym_sampling</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Sample synonym pairs from a list of synonym groups extracted from the input ontology.</p>
<p>According to the <span class="arithmatex">\(\textsf{BERTMap}\)</span> paper, <strong>synonyms</strong> are defined as label pairs that belong
to the same ontology class.</p>
<p>NOTE this has been validated for getting the same results as in the original <span class="arithmatex">\(\textsf{BERTMap}\)</span> repository.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>num_samples</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The (maximum) number of <strong>unique</strong> samples extracted. Defaults to <code>None</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[str, str]]</code>
          </td>
          <td><p>A list of unique synonym pair samples.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">synonym_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample synonym pairs from a list of synonym groups extracted from the input ontology.</span>

<span class="sd">    According to the $\textsf{BERTMap}$ paper, **synonyms** are defined as label pairs that belong</span>
<span class="sd">    to the same ontology class.</span>

<span class="sd">    NOTE this has been validated for getting the same results as in the original $\textsf{BERTMap}$ repository.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_samples (int, optional): The (maximum) number of **unique** samples extracted. Defaults to `None`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[Tuple[str, str]]): A list of unique synonym pair samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synonym_pool</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">synonym_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span><span class="p">:</span>
        <span class="c1"># do not remove duplicates in the loop to save time</span>
        <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_synonym_pairs</span><span class="p">(</span><span class="n">synonym_group</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">synonym_pool</span> <span class="o">+=</span> <span class="n">synonym_pairs</span>
    <span class="c1"># remove duplicates afer the loop</span>
    <span class="n">synonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">synonym_pool</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">num_samples</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_samples</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">synonym_pool</span><span class="p">)):</span>
        <span class="c1"># print(&quot;Return all synonym pairs without downsampling.&quot;)</span>
        <span class="k">return</span> <span class="n">synonym_pool</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">synonym_pool</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.AnnotationThesaurus.soft_nonsynonym_sampling" class="doc doc-heading">
<code class="highlight language-python"><span class="n">soft_nonsynonym_sampling</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Sample <strong>soft</strong> non-synonyms from a list of synonym groups extracted from the input ontology.</p>
<p>According to the <span class="arithmatex">\(\textsf{BERTMap}\)</span> paper, <strong>soft non-synonyms</strong> are defined as label pairs
from two <em>different</em> synonym groups that are <strong>randomly</strong> selected.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>num_samples</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The (maximum) number of <strong>unique</strong> samples extracted; this is
required <strong>unlike for synonym sampling</strong> because the non-synonym pool is <strong>significantly
larger</strong> (considering random combinations of different synonym groups).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>max_iter</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The maximum number of iterations for conducting sampling. Defaults to <code>5</code>.</p></td>
          <td>
                <code>5</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[str, str]]</code>
          </td>
          <td><p>A list of unique (soft) non-synonym pair samples.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">soft_nonsynonym_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample **soft** non-synonyms from a list of synonym groups extracted from the input ontology.</span>

<span class="sd">    According to the $\textsf{BERTMap}$ paper, **soft non-synonyms** are defined as label pairs</span>
<span class="sd">    from two *different* synonym groups that are **randomly** selected.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_samples (int): The (maximum) number of **unique** samples extracted; this is</span>
<span class="sd">            required **unlike for synonym sampling** because the non-synonym pool is **significantly</span>
<span class="sd">            larger** (considering random combinations of different synonym groups).</span>
<span class="sd">        max_iter (int): The maximum number of iterations for conducting sampling. Defaults to `5`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[Tuple[str, str]]): A list of unique (soft) non-synonym pair samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nonsyonym_pool</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># randomly select disjoint synonym group pairs from all</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="n">left_synonym_group</span><span class="p">,</span> <span class="n">right_synonym_group</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonym_groups</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># randomly choose one label from a synonym group</span>
        <span class="n">left_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">left_synonym_group</span><span class="p">))</span>
        <span class="n">right_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">right_synonym_group</span><span class="p">))</span>
        <span class="n">nonsyonym_pool</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_label</span><span class="p">,</span> <span class="n">right_label</span><span class="p">))</span>

    <span class="c1"># DataUtils.uniqify is too slow so we should avoid operating it too often</span>
    <span class="n">nonsyonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsyonym_pool</span><span class="p">)</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsyonym_pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_samples</span> <span class="ow">and</span> <span class="n">max_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># reduce the iteration to prevent exhausting loop</span>
        <span class="n">nonsyonym_pool</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soft_nonsynonym_sampling</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsyonym_pool</span><span class="p">),</span> <span class="n">max_iter</span><span class="p">)</span>
        <span class="n">nonsyonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsyonym_pool</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nonsyonym_pool</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.AnnotationThesaurus.weighted_random_choices_of_sibling_groups" class="doc doc-heading">
<code class="highlight language-python"><span class="n">weighted_random_choices_of_sibling_groups</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Randomly (weighted) select a number of sibling class groups.</p>
<p>The weights are computed according to the sizes of the sibling class groups.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">weighted_random_choices_of_sibling_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Randomly (weighted) select a number of sibling class groups.</span>

<span class="sd">    The weights are computed according to the sizes of the sibling class groups.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">sibling_class_groups</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>  <span class="c1"># normalised</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">sibling_class_groups</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.AnnotationThesaurus.hard_nonsynonym_sampling" class="doc doc-heading">
<code class="highlight language-python"><span class="n">hard_nonsynonym_sampling</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Sample <strong>hard</strong> non-synonyms from sibling classes of the input ontology.</p>
<p>According to the <span class="arithmatex">\(\textsf{BERTMap}\)</span> paper, <strong>hard non-synonyms</strong> are defined as label pairs
that belong to two <strong>disjoint</strong> ontology classes. For practical reason, the condition
is eased to two <strong>sibling</strong> ontology classes.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>num_samples</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The (maximum) number of <strong>unique</strong> samples extracted; this is
required <strong>unlike for synonym sampling</strong> because the non-synonym pool is <strong>significantly
larger</strong> (considering random combinations of different synonym groups).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>max_iter</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The maximum number of iterations for conducting sampling. Defaults to <code>5</code>.</p></td>
          <td>
                <code>5</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[str, str]]</code>
          </td>
          <td><p>A list of unique (hard) non-synonym pair samples.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">hard_nonsynonym_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample **hard** non-synonyms from sibling classes of the input ontology.</span>

<span class="sd">    According to the $\textsf{BERTMap}$ paper, **hard non-synonyms** are defined as label pairs</span>
<span class="sd">    that belong to two **disjoint** ontology classes. For practical reason, the condition</span>
<span class="sd">    is eased to two **sibling** ontology classes.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_samples (int): The (maximum) number of **unique** samples extracted; this is</span>
<span class="sd">            required **unlike for synonym sampling** because the non-synonym pool is **significantly</span>
<span class="sd">            larger** (considering random combinations of different synonym groups).</span>
<span class="sd">        max_iter (int): The maximum number of iterations for conducting sampling. Defaults to `5`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[Tuple[str, str]]): A list of unique (hard) non-synonym pair samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># intialise the sibling class groups</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">onto</span><span class="o">.</span><span class="n">sibling_class_groups</span>

    <span class="c1"># flatten the disjointness groups into all pairs of hard neagtives</span>
    <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># randomly (weighted) select a number of sibling class groups with replacement</span>
    <span class="n">sibling_class_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_random_choices_of_sibling_groups</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">sibling_class_group</span> <span class="ow">in</span> <span class="n">sibling_class_groups</span><span class="p">:</span>
        <span class="c1"># random select two sibling classes; no weights this time</span>
        <span class="n">left_class_iri</span><span class="p">,</span> <span class="n">right_class_iri</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sibling_class_group</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># random select a label for each of them</span>
        <span class="n">left_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">left_class_iri</span><span class="p">]))</span>
        <span class="n">right_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">right_class_iri</span><span class="p">]))</span>
        <span class="c1"># add the label pair to the pool</span>
        <span class="n">nonsynonym_pool</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_label</span><span class="p">,</span> <span class="n">right_label</span><span class="p">))</span>

    <span class="c1"># DataUtils.uniqify is too slow so we should avoid operating it too often</span>
    <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_samples</span> <span class="ow">and</span> <span class="n">max_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># reduce the iteration to prevent exhausting loop</span>
        <span class="n">nonsynonym_pool</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_nonsynonym_sampling</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">),</span> <span class="n">max_iter</span><span class="p">)</span>
        <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nonsynonym_pool</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="deeponto.align.bertmap.text_semantics.IntraOntologyTextSemanticsCorpus" class="doc doc-heading">
        <code>IntraOntologyTextSemanticsCorpus</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Class for creating the intra-ontology text semantics corpus from an ontology.</p>
<p>As defined in the <span class="arithmatex">\(\textsf{BERTMap}\)</span> paper, the <strong>intra-ontology</strong> text semantics corpus consists
of synonym and non-synonym pairs extracted from the ontology class annotations.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>An ontology to construct the intra-ontology text semantics corpus from.</p></td>
        </tr>
        <tr>
          <td><code>annotation_property_iris</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>Specify which annotation properties to be used.</p></td>
        </tr>
        <tr>
          <td><code>soft_negative_ratio</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The expected negative sample ratio of the soft non-synonyms to the extracted synonyms. Defaults to <code>2</code>.</p></td>
        </tr>
        <tr>
          <td><code>hard_negative_ratio</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The expected negative sample ratio of the hard non-synonyms to the extracted synonyms. Defaults to <code>2</code>.
However, hard non-synonyms are sometimes insufficient given an ontology's hierarchy, the soft ones are used to compensate
the number in this case.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">IntraOntologyTextSemanticsCorpus</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for creating the intra-ontology text semantics corpus from an ontology.</span>

<span class="sd">    As defined in the $\textsf{BERTMap}$ paper, the **intra-ontology** text semantics corpus consists</span>
<span class="sd">    of synonym and non-synonym pairs extracted from the ontology class annotations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        onto (Ontology): An ontology to construct the intra-ontology text semantics corpus from.</span>
<span class="sd">        annotation_property_iris (List[str]): Specify which annotation properties to be used.</span>
<span class="sd">        soft_negative_ratio (int): The expected negative sample ratio of the soft non-synonyms to the extracted synonyms. Defaults to `2`.</span>
<span class="sd">        hard_negative_ratio (int): The expected negative sample ratio of the hard non-synonyms to the extracted synonyms. Defaults to `2`.</span>
<span class="sd">            However, hard non-synonyms are sometimes insufficient given an ontology&#39;s hierarchy, the soft ones are used to compensate</span>
<span class="sd">            the number in this case.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span>
        <span class="n">annotation_property_iris</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">soft_negative_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">hard_negative_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">onto</span> <span class="o">=</span> <span class="n">onto</span>
        <span class="c1"># $\textsf{BERTMap}$ does not apply synonym transitivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thesaurus</span> <span class="o">=</span> <span class="n">AnnotationThesaurus</span><span class="p">(</span><span class="n">onto</span><span class="p">,</span> <span class="n">annotation_property_iris</span><span class="p">,</span> <span class="n">apply_transitivity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thesaurus</span><span class="o">.</span><span class="n">synonym_sampling</span><span class="p">()</span>
        <span class="c1"># sample hard negatives first as they might not be enough</span>
        <span class="n">num_hard</span> <span class="o">=</span> <span class="n">hard_negative_ratio</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hard_nonsynonyms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thesaurus</span><span class="o">.</span><span class="n">hard_nonsynonym_sampling</span><span class="p">(</span><span class="n">num_hard</span><span class="p">)</span>
        <span class="c1"># compensate the number of hard negatives as soft negatives are almost always available</span>
        <span class="n">num_soft</span> <span class="o">=</span> <span class="p">(</span><span class="n">soft_negative_ratio</span> <span class="o">+</span> <span class="n">hard_negative_ratio</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hard_nonsynonyms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soft_nonsynonyms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thesaurus</span><span class="o">.</span><span class="n">soft_nonsynonym_sampling</span><span class="p">(</span><span class="n">num_soft</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_synonyms&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">),</span>
                <span class="s2">&quot;num_nonsynonyms&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soft_nonsynonyms</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hard_nonsynonyms</span><span class="p">),</span>
                <span class="s2">&quot;num_soft_nonsynonyms&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soft_nonsynonyms</span><span class="p">),</span>
                <span class="s2">&quot;num_hard_nonsynonyms&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hard_nonsynonyms</span><span class="p">),</span>
                <span class="s2">&quot;annotation_thesaurus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thesaurus</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;AnnotationThesaurus&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the intra-ontology corpus (a `.json` file for label pairs</span>
<span class="sd">        and its summary) in the specified directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="n">save_json</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
            <span class="s2">&quot;synonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">],</span>
            <span class="s2">&quot;nonsynonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">neg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">neg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">soft_nonsynonyms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_nonsynonyms</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">save_json</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;intra-onto.corpus.json&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.IntraOntologyTextSemanticsCorpus.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Save the intra-ontology corpus (a <code>.json</code> file for label pairs
and its summary) in the specified directory.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the intra-ontology corpus (a `.json` file for label pairs</span>
<span class="sd">    and its summary) in the specified directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
    <span class="n">save_json</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
        <span class="s2">&quot;synonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">],</span>
        <span class="s2">&quot;nonsynonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">neg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">neg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">soft_nonsynonyms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_nonsynonyms</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">save_json</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;intra-onto.corpus.json&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus" class="doc doc-heading">
        <code>CrossOntologyTextSemanticsCorpus</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Class for creating the cross-ontology text semantics corpus from two ontologies and provided mappings between them.</p>
<p>As defined in the <span class="arithmatex">\(\textsf{BERTMap}\)</span> paper, the <strong>cross-ontology</strong> text semantics corpus consists
of synonym and non-synonym pairs extracted from the annotations/labels of class pairs
involved in the provided cross-ontology mappigns.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>class_mappings</code></td>
          <td>
                <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="deeponto.align.mapping.ReferenceMapping" href="../mapping/#deeponto.align.mapping.ReferenceMapping">ReferenceMapping</a>]</code>
          </td>
          <td><p>A list of cross-ontology class mappings.</p></td>
        </tr>
        <tr>
          <td><code>src_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The source ontology whose class IRIs are heads of the <code>class_mappings</code>.</p></td>
        </tr>
        <tr>
          <td><code>tgt_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The target ontology whose class IRIs are tails of the <code>class_mappings</code>.</p></td>
        </tr>
        <tr>
          <td><code>annotation_property_iris</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>A list of annotation property IRIs used to extract the annotations.</p></td>
        </tr>
        <tr>
          <td><code>negative_ratio</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The expected negative sample ratio of the non-synonyms to the extracted synonyms. Defaults to <code>4</code>. NOTE
that we do not have <em>hard</em> non-synonyms at the cross-ontology level.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CrossOntologyTextSemanticsCorpus</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for creating the cross-ontology text semantics corpus from two ontologies and provided mappings between them.</span>

<span class="sd">    As defined in the $\textsf{BERTMap}$ paper, the **cross-ontology** text semantics corpus consists</span>
<span class="sd">    of synonym and non-synonym pairs extracted from the annotations/labels of class pairs</span>
<span class="sd">    involved in the provided cross-ontology mappigns.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        class_mappings (List[ReferenceMapping]): A list of cross-ontology class mappings.</span>
<span class="sd">        src_onto (Ontology): The source ontology whose class IRIs are heads of the `class_mappings`.</span>
<span class="sd">        tgt_onto (Ontology): The target ontology whose class IRIs are tails of the `class_mappings`.</span>
<span class="sd">        annotation_property_iris (List[str]): A list of annotation property IRIs used to extract the annotations.</span>
<span class="sd">        negative_ratio (int): The expected negative sample ratio of the non-synonyms to the extracted synonyms. Defaults to `4`. NOTE</span>
<span class="sd">            that we do not have *hard* non-synonyms at the cross-ontology level.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">class_mappings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ReferenceMapping</span><span class="p">],</span>
        <span class="n">src_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span>
        <span class="n">tgt_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span>
        <span class="n">annotation_property_iris</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">negative_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_mappings</span> <span class="o">=</span> <span class="n">class_mappings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span> <span class="o">=</span> <span class="n">src_onto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span> <span class="o">=</span> <span class="n">tgt_onto</span>
        <span class="c1"># build the annotation thesaurus for each ontology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_thesaurus</span> <span class="o">=</span> <span class="n">AnnotationThesaurus</span><span class="p">(</span><span class="n">src_onto</span><span class="p">,</span> <span class="n">annotation_property_iris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_thesaurus</span> <span class="o">=</span> <span class="n">AnnotationThesaurus</span><span class="p">(</span><span class="n">tgt_onto</span><span class="p">,</span> <span class="n">annotation_property_iris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negative_ratio</span> <span class="o">=</span> <span class="n">negative_ratio</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synonym_sampling_from_mappings</span><span class="p">()</span>
        <span class="n">num_negative</span> <span class="o">=</span> <span class="n">negative_ratio</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonym_sampling_from_mappings</span><span class="p">(</span><span class="n">num_negative</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_synonyms&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">),</span>
                <span class="s2">&quot;num_nonsynonyms&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span><span class="p">),</span>
                <span class="s2">&quot;num_mappings&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_mappings</span><span class="p">),</span>
                <span class="s2">&quot;src_annotation_thesaurus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_thesaurus</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;AnnotationThesaurus&quot;</span><span class="p">],</span>
                <span class="s2">&quot;tgt_annotation_thesaurus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_thesaurus</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;AnnotationThesaurus&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the cross-ontology corpus (a `.json` file for label pairs</span>
<span class="sd">        and its summary) in the specified directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="n">save_json</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
            <span class="s2">&quot;synonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">],</span>
            <span class="s2">&quot;nonsynonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">neg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">neg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">save_json</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;cross-onto.corpus.json&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">synonym_sampling_from_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample synonyms from cross-ontology class mappings.</span>

<span class="sd">        Arguements of this method are all class attributes.</span>
<span class="sd">        See [`CrossOntologyTextSemanticsCorpus`][deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus].</span>

<span class="sd">        According to the $\textsf{BERTMap}$ paper, **cross-ontology synonyms** are defined as label pairs</span>
<span class="sd">        that belong to two **matched** classes. Suppose the class $C$ from the source ontology</span>
<span class="sd">        and the class $D$ from the target ontology are matched according to one of the `class_mappings`,</span>
<span class="sd">        then the cartesian product of labels of $C$ and labels of $D$ form cross-ontology synonyms.</span>
<span class="sd">        Note that **identity synonyms** in the form of $(a, a)$ are removed because they have been covered</span>
<span class="sd">        in the intra-ontology case.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[Tuple[str, str]]): A list of unique synonym pair samples from ontology class mappings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">synonym_pool</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">class_mapping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_mappings</span><span class="p">:</span>
            <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span> <span class="o">=</span> <span class="n">class_mapping</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">()</span>
            <span class="n">src_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_thesaurus</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">src_class_iri</span><span class="p">]</span>
            <span class="n">tgt_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_thesaurus</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">tgt_class_iri</span><span class="p">]</span>
            <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">))</span>
            <span class="c1"># remove the identity synonyms as the have been covered in the intra-ontology case</span>
            <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">synonym_pairs</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="n">r</span><span class="p">]</span>
            <span class="n">backward_synonym_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">synonym_pairs</span><span class="p">]</span>
            <span class="n">synonym_pool</span> <span class="o">+=</span> <span class="n">synonym_pairs</span> <span class="o">+</span> <span class="n">backward_synonym_pairs</span>

        <span class="n">synonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">synonym_pool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">synonym_pool</span>

    <span class="k">def</span> <span class="nf">nonsynonym_sampling_from_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample non-synonyms from cross-ontology class mappings.</span>

<span class="sd">        Arguements of this method are all class attributes.</span>
<span class="sd">        See [`CrossOntologyTextSemanticsCorpus`][deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus].</span>

<span class="sd">        According to the $\textsf{BERTMap}$ paper, **cross-ontology non-synonyms** are defined as label pairs</span>
<span class="sd">        that belong to two **unmatched** classes. Assume that the provided class mappings are self-contained</span>
<span class="sd">        in the sense that they are complete for the classes involved in them, then we can randomly</span>
<span class="sd">        sample two cross-ontology classes that are not matched according to the mappings and take</span>
<span class="sd">        their labels as nonsynonyms. In practice, it is quite unlikely to obtain false negatives since</span>
<span class="sd">        the number of incorrect mappings is much larger than the number of correct ones.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[Tuple[str, str]]): A list of unique nonsynonym pair samples from ontology class mappings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># form cross-ontology synonym groups</span>
        <span class="n">cross_onto_synonym_group_pair</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">class_mapping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_mappings</span><span class="p">:</span>
            <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span> <span class="o">=</span> <span class="n">class_mapping</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">()</span>
            <span class="n">src_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_thesaurus</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">src_class_iri</span><span class="p">]</span>
            <span class="n">tgt_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_thesaurus</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">tgt_class_iri</span><span class="p">]</span>
            <span class="c1"># let each matched class pair&#39;s annotations form a synonym group_pair</span>
            <span class="n">cross_onto_synonym_group_pair</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">))</span>

        <span class="c1"># randomly select disjoint synonym group pairs from all</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
            <span class="n">left_class_pair</span><span class="p">,</span> <span class="n">right_class_pair</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">cross_onto_synonym_group_pair</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="c1"># randomly choose one label from a synonym group</span>
            <span class="n">left_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">left_class_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># choosing the src side by [0]</span>
            <span class="n">right_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">right_class_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># choosing the tgt side by [1]</span>
            <span class="n">nonsynonym_pool</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_label</span><span class="p">,</span> <span class="n">right_label</span><span class="p">))</span>

        <span class="c1"># DataUtils.uniqify is too slow so we should avoid operating it too often</span>
        <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_samples</span> <span class="ow">and</span> <span class="n">max_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># reduce the iteration to prevent exhausting loop</span>
            <span class="n">nonsynonym_pool</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonym_sampling_from_mappings</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">),</span> <span class="n">max_iter</span><span class="p">)</span>
            <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nonsynonym_pool</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Save the cross-ontology corpus (a <code>.json</code> file for label pairs
and its summary) in the specified directory.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the cross-ontology corpus (a `.json` file for label pairs</span>
<span class="sd">    and its summary) in the specified directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
    <span class="n">save_json</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
        <span class="s2">&quot;synonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">],</span>
        <span class="s2">&quot;nonsynonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">neg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">neg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">save_json</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;cross-onto.corpus.json&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus.synonym_sampling_from_mappings" class="doc doc-heading">
<code class="highlight language-python"><span class="n">synonym_sampling_from_mappings</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Sample synonyms from cross-ontology class mappings.</p>
<p>Arguements of this method are all class attributes.
See <a class="autorefs autorefs-internal" href="#deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus"><code>CrossOntologyTextSemanticsCorpus</code></a>.</p>
<p>According to the <span class="arithmatex">\(\textsf{BERTMap}\)</span> paper, <strong>cross-ontology synonyms</strong> are defined as label pairs
that belong to two <strong>matched</strong> classes. Suppose the class <span class="arithmatex">\(C\)</span> from the source ontology
and the class <span class="arithmatex">\(D\)</span> from the target ontology are matched according to one of the <code>class_mappings</code>,
then the cartesian product of labels of <span class="arithmatex">\(C\)</span> and labels of <span class="arithmatex">\(D\)</span> form cross-ontology synonyms.
Note that <strong>identity synonyms</strong> in the form of <span class="arithmatex">\((a, a)\)</span> are removed because they have been covered
in the intra-ontology case.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[str, str]]</code>
          </td>
          <td><p>A list of unique synonym pair samples from ontology class mappings.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">synonym_sampling_from_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample synonyms from cross-ontology class mappings.</span>

<span class="sd">    Arguements of this method are all class attributes.</span>
<span class="sd">    See [`CrossOntologyTextSemanticsCorpus`][deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus].</span>

<span class="sd">    According to the $\textsf{BERTMap}$ paper, **cross-ontology synonyms** are defined as label pairs</span>
<span class="sd">    that belong to two **matched** classes. Suppose the class $C$ from the source ontology</span>
<span class="sd">    and the class $D$ from the target ontology are matched according to one of the `class_mappings`,</span>
<span class="sd">    then the cartesian product of labels of $C$ and labels of $D$ form cross-ontology synonyms.</span>
<span class="sd">    Note that **identity synonyms** in the form of $(a, a)$ are removed because they have been covered</span>
<span class="sd">    in the intra-ontology case.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[Tuple[str, str]]): A list of unique synonym pair samples from ontology class mappings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synonym_pool</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">class_mapping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_mappings</span><span class="p">:</span>
        <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span> <span class="o">=</span> <span class="n">class_mapping</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">()</span>
        <span class="n">src_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_thesaurus</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">src_class_iri</span><span class="p">]</span>
        <span class="n">tgt_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_thesaurus</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">tgt_class_iri</span><span class="p">]</span>
        <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">))</span>
        <span class="c1"># remove the identity synonyms as the have been covered in the intra-ontology case</span>
        <span class="n">synonym_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">synonym_pairs</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="n">r</span><span class="p">]</span>
        <span class="n">backward_synonym_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">synonym_pairs</span><span class="p">]</span>
        <span class="n">synonym_pool</span> <span class="o">+=</span> <span class="n">synonym_pairs</span> <span class="o">+</span> <span class="n">backward_synonym_pairs</span>

    <span class="n">synonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">synonym_pool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">synonym_pool</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus.nonsynonym_sampling_from_mappings" class="doc doc-heading">
<code class="highlight language-python"><span class="n">nonsynonym_sampling_from_mappings</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Sample non-synonyms from cross-ontology class mappings.</p>
<p>Arguements of this method are all class attributes.
See <a class="autorefs autorefs-internal" href="#deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus"><code>CrossOntologyTextSemanticsCorpus</code></a>.</p>
<p>According to the <span class="arithmatex">\(\textsf{BERTMap}\)</span> paper, <strong>cross-ontology non-synonyms</strong> are defined as label pairs
that belong to two <strong>unmatched</strong> classes. Assume that the provided class mappings are self-contained
in the sense that they are complete for the classes involved in them, then we can randomly
sample two cross-ontology classes that are not matched according to the mappings and take
their labels as nonsynonyms. In practice, it is quite unlikely to obtain false negatives since
the number of incorrect mappings is much larger than the number of correct ones.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[str, str]]</code>
          </td>
          <td><p>A list of unique nonsynonym pair samples from ontology class mappings.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">nonsynonym_sampling_from_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sample non-synonyms from cross-ontology class mappings.</span>

<span class="sd">    Arguements of this method are all class attributes.</span>
<span class="sd">    See [`CrossOntologyTextSemanticsCorpus`][deeponto.align.bertmap.text_semantics.CrossOntologyTextSemanticsCorpus].</span>

<span class="sd">    According to the $\textsf{BERTMap}$ paper, **cross-ontology non-synonyms** are defined as label pairs</span>
<span class="sd">    that belong to two **unmatched** classes. Assume that the provided class mappings are self-contained</span>
<span class="sd">    in the sense that they are complete for the classes involved in them, then we can randomly</span>
<span class="sd">    sample two cross-ontology classes that are not matched according to the mappings and take</span>
<span class="sd">    their labels as nonsynonyms. In practice, it is quite unlikely to obtain false negatives since</span>
<span class="sd">    the number of incorrect mappings is much larger than the number of correct ones.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[Tuple[str, str]]): A list of unique nonsynonym pair samples from ontology class mappings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># form cross-ontology synonym groups</span>
    <span class="n">cross_onto_synonym_group_pair</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">class_mapping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_mappings</span><span class="p">:</span>
        <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span> <span class="o">=</span> <span class="n">class_mapping</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">()</span>
        <span class="n">src_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_thesaurus</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">src_class_iri</span><span class="p">]</span>
        <span class="n">tgt_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_thesaurus</span><span class="o">.</span><span class="n">annotation_index</span><span class="p">[</span><span class="n">tgt_class_iri</span><span class="p">]</span>
        <span class="c1"># let each matched class pair&#39;s annotations form a synonym group_pair</span>
        <span class="n">cross_onto_synonym_group_pair</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">))</span>

    <span class="c1"># randomly select disjoint synonym group pairs from all</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="n">left_class_pair</span><span class="p">,</span> <span class="n">right_class_pair</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">cross_onto_synonym_group_pair</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># randomly choose one label from a synonym group</span>
        <span class="n">left_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">left_class_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># choosing the src side by [0]</span>
        <span class="n">right_label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">right_class_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># choosing the tgt side by [1]</span>
        <span class="n">nonsynonym_pool</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left_label</span><span class="p">,</span> <span class="n">right_label</span><span class="p">))</span>

    <span class="c1"># DataUtils.uniqify is too slow so we should avoid operating it too often</span>
    <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_samples</span> <span class="ow">and</span> <span class="n">max_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># reduce the iteration to prevent exhausting loop</span>
        <span class="n">nonsynonym_pool</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonym_sampling_from_mappings</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">),</span> <span class="n">max_iter</span><span class="p">)</span>
        <span class="n">nonsynonym_pool</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">nonsynonym_pool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nonsynonym_pool</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="deeponto.align.bertmap.text_semantics.TextSemanticsCorpora" class="doc doc-heading">
        <code>TextSemanticsCorpora</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Class for creating the collection text semantics corpora.</p>
<p>As defined in the <span class="arithmatex">\(\textsf{BERTMap}\)</span> paper, the collection of text semantics corpora contains
<strong>at least two intra-ontology sub-corpora</strong> from the source and target ontologies, respectively.
If some class mappings are provided, then a <strong>cross-ontology sub-corpus</strong> will be created.
If some additional auxiliary ontologies are provided, the intra-ontology corpora created from them
will serve as the <strong>auxiliary sub-corpora</strong>.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The source ontology to be matched or aligned.</p></td>
        </tr>
        <tr>
          <td><code>tgt_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The target ontology to be matched or aligned.</p></td>
        </tr>
        <tr>
          <td><code>annotation_property_iris</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>A list of annotation property IRIs used to extract the annotations.</p></td>
        </tr>
        <tr>
          <td><code>class_mappings</code></td>
          <td>
                <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="deeponto.align.mapping.ReferenceMapping" href="../mapping/#deeponto.align.mapping.ReferenceMapping">ReferenceMapping</a>]</code>
          </td>
          <td><p>A list of cross-ontology class mappings between the
source and the target ontologies. Defaults to <code>None</code>.</p></td>
        </tr>
        <tr>
          <td><code>auxiliary_ontos</code></td>
          <td>
                <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a>]</code>
          </td>
          <td><p>A list of auxiliary ontologies for augmenting more synonym/non-synonym samples. Defaults to <code>None</code>.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TextSemanticsCorpora</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for creating the collection text semantics corpora.</span>

<span class="sd">    As defined in the $\textsf{BERTMap}$ paper, the collection of text semantics corpora contains</span>
<span class="sd">    **at least two intra-ontology sub-corpora** from the source and target ontologies, respectively.</span>
<span class="sd">    If some class mappings are provided, then a **cross-ontology sub-corpus** will be created.</span>
<span class="sd">    If some additional auxiliary ontologies are provided, the intra-ontology corpora created from them</span>
<span class="sd">    will serve as the **auxiliary sub-corpora**.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        src_onto (Ontology): The source ontology to be matched or aligned.</span>
<span class="sd">        tgt_onto (Ontology): The target ontology to be matched or aligned.</span>
<span class="sd">        annotation_property_iris (List[str]): A list of annotation property IRIs used to extract the annotations.</span>
<span class="sd">        class_mappings (List[ReferenceMapping], optional): A list of cross-ontology class mappings between the</span>
<span class="sd">            source and the target ontologies. Defaults to `None`.</span>
<span class="sd">        auxiliary_ontos (List[Ontology], optional): A list of auxiliary ontologies for augmenting more synonym/non-synonym samples. Defaults to `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">src_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span>
        <span class="n">tgt_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span>
        <span class="n">annotation_property_iris</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">class_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ReferenceMapping</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auxiliary_ontos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Ontology</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># build intra-ontology corpora</span>
        <span class="c1"># negative sample ratios are by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_src_onto_corpus</span> <span class="o">=</span> <span class="n">IntraOntologyTextSemanticsCorpus</span><span class="p">(</span><span class="n">src_onto</span><span class="p">,</span> <span class="n">annotation_property_iris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_samples_from_sub_corpus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_src_onto_corpus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_tgt_onto_corpus</span> <span class="o">=</span> <span class="n">IntraOntologyTextSemanticsCorpus</span><span class="p">(</span><span class="n">tgt_onto</span><span class="p">,</span> <span class="n">annotation_property_iris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_samples_from_sub_corpus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_tgt_onto_corpus</span><span class="p">)</span>

        <span class="c1"># build cross-ontolgoy corpora</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_mappings</span> <span class="o">=</span> <span class="n">class_mappings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_onto_corpus</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_mappings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cross_onto_corpus</span> <span class="o">=</span> <span class="n">CrossOntologyTextSemanticsCorpus</span><span class="p">(</span>
                <span class="n">class_mappings</span><span class="p">,</span> <span class="n">src_onto</span><span class="p">,</span> <span class="n">tgt_onto</span><span class="p">,</span> <span class="n">annotation_property_iris</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_samples_from_sub_corpus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_onto_corpus</span><span class="p">)</span>

        <span class="c1"># build auxiliary ontology corpora (same as intra-ontology)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span> <span class="o">=</span> <span class="n">auxiliary_ontos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_onto_corpora</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">auxiliary_onto</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_ontos</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_onto_corpora</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">IntraOntologyTextSemanticsCorpus</span><span class="p">(</span><span class="n">auxiliary_onto</span><span class="p">,</span> <span class="n">annotation_property_iris</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">auxiliary_onto_corpus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_onto_corpora</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_samples_from_sub_corpus</span><span class="p">(</span><span class="n">auxiliary_onto_corpus</span><span class="p">)</span>

        <span class="c1"># DataUtils.uniqify the samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span> <span class="o">=</span> <span class="n">DataUtils</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span><span class="p">)</span>
        <span class="c1"># remove invalid nonsynonyms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">))</span>

        <span class="c1"># summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_synonyms&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">),</span>
                <span class="s2">&quot;num_nonsynonyms&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span><span class="p">),</span>
                <span class="s2">&quot;intra_src_onto_corpus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_src_onto_corpus</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;IntraOntologyTextSemanticsCorpus&quot;</span><span class="p">],</span>
                <span class="s2">&quot;intra_tgt_onto_corpus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_tgt_onto_corpus</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;IntraOntologyTextSemanticsCorpus&quot;</span><span class="p">],</span>
                <span class="s2">&quot;cross_onto_corpus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_onto_corpus</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;CrossOntologyTextSemanticsCorpus&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_onto_corpus</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;auxiliary_onto_corpora&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;IntraOntologyTextSemanticsCorpus&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_onto_corpora</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the overall text semantics corpora (a `.json` file for label pairs</span>
<span class="sd">        and its summary) in the specified directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="n">save_json</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
            <span class="s2">&quot;synonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">],</span>
            <span class="s2">&quot;nonsynonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">neg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">neg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">save_json</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;text-semantics.corpora.json&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_samples_from_sub_corpus</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sub_corpus</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IntraOntologyTextSemanticsCorpus</span><span class="p">,</span> <span class="n">CrossOntologyTextSemanticsCorpus</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add synonyms and non-synonyms from each sub-corpus to the overall collection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span> <span class="o">+=</span> <span class="n">sub_corpus</span><span class="o">.</span><span class="n">synonyms</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_corpus</span><span class="p">,</span> <span class="n">IntraOntologyTextSemanticsCorpus</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span> <span class="o">+=</span> <span class="n">sub_corpus</span><span class="o">.</span><span class="n">soft_nonsynonyms</span> <span class="o">+</span> <span class="n">sub_corpus</span><span class="o">.</span><span class="n">hard_nonsynonyms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span> <span class="o">+=</span> <span class="n">sub_corpus</span><span class="o">.</span><span class="n">nonsynonyms</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.TextSemanticsCorpora.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Save the overall text semantics corpora (a <code>.json</code> file for label pairs
and its summary) in the specified directory.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the overall text semantics corpora (a `.json` file for label pairs</span>
<span class="sd">    and its summary) in the specified directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
    <span class="n">save_json</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
        <span class="s2">&quot;synonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span><span class="p">],</span>
        <span class="s2">&quot;nonsynonyms&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">neg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">neg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">save_json</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;text-semantics.corpora.json&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.text_semantics.TextSemanticsCorpora.add_samples_from_sub_corpus" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_samples_from_sub_corpus</span><span class="p">(</span><span class="n">sub_corpus</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Add synonyms and non-synonyms from each sub-corpus to the overall collection.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/text_semantics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_samples_from_sub_corpus</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">sub_corpus</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IntraOntologyTextSemanticsCorpus</span><span class="p">,</span> <span class="n">CrossOntologyTextSemanticsCorpus</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add synonyms and non-synonyms from each sub-corpus to the overall collection.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">synonyms</span> <span class="o">+=</span> <span class="n">sub_corpus</span><span class="o">.</span><span class="n">synonyms</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_corpus</span><span class="p">,</span> <span class="n">IntraOntologyTextSemanticsCorpus</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span> <span class="o">+=</span> <span class="n">sub_corpus</span><span class="o">.</span><span class="n">soft_nonsynonyms</span> <span class="o">+</span> <span class="n">sub_corpus</span><span class="o">.</span><span class="n">hard_nonsynonyms</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonsynonyms</span> <span class="o">+=</span> <span class="n">sub_corpus</span><span class="o">.</span><span class="n">nonsynonyms</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier" class="doc doc-heading">
        <code>BERTSynonymClassifier</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Class for BERT synonym classifier.</p>
<p>The main scoring module of <span class="arithmatex">\(\textsf{BERTMap}\)</span> consisting of a BERT model and a binary synonym classifier.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>loaded_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to the checkpoint of a pre-trained BERT model.</p></td>
        </tr>
        <tr>
          <td><code>output_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to the output BERT model (usually fine-tuned).</p></td>
        </tr>
        <tr>
          <td><code>eval_mode</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Set to <code>False</code> if the model is loaded for training.</p></td>
        </tr>
        <tr>
          <td><code>max_length_for_input</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The maximum length of an input sequence.</p></td>
        </tr>
        <tr>
          <td><code>num_epochs_for_training</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of epochs for training a BERT model.</p></td>
        </tr>
        <tr>
          <td><code>batch_size_for_training</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The batch size for training a BERT model.</p></td>
        </tr>
        <tr>
          <td><code>batch_size_for_prediction</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The batch size for making predictions.</p></td>
        </tr>
        <tr>
          <td><code>training_data</code></td>
          <td>
                <code><span title="datasets.Dataset">Dataset</span></code>
          </td>
          <td><p>Data for training the model if <code>for_training</code> is set to <code>True</code>. Defaults to <code>None</code>.</p></td>
        </tr>
        <tr>
          <td><code>validation_data</code></td>
          <td>
                <code><span title="datasets.Dataset">Dataset</span></code>
          </td>
          <td><p>Data for validating the model if <code>for_training</code> is set to <code>True</code>. Defaults to <code>None</code>.</p></td>
        </tr>
        <tr>
          <td><code>training_args</code></td>
          <td>
                <code><span title="transformers.TrainingArguments">TrainingArguments</span></code>
          </td>
          <td><p>Training arguments for training the model if <code>for_training</code> is set to <code>True</code>. Defaults to <code>None</code>.</p></td>
        </tr>
        <tr>
          <td><code>trainer</code></td>
          <td>
                <code><span title="transformers.Trainer">Trainer</span></code>
          </td>
          <td><p>The model trainer fed with <code>training_args</code> and data samples. Defaults to <code>None</code>.</p></td>
        </tr>
        <tr>
          <td><code>softmax</code></td>
          <td>
                <code>torch.<span title="torch.nn">nn</span>.<span title="torch.nn.SoftMax">SoftMax</span></code>
          </td>
          <td><p>The softmax layer used for normalising synonym scores. Defaults to <code>None</code>.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>deeponto/align/bertmap/bert_classifier.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BERTSynonymClassifier</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for BERT synonym classifier.</span>

<span class="sd">    The main scoring module of $\textsf{BERTMap}$ consisting of a BERT model and a binary synonym classifier.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        loaded_path (str): The path to the checkpoint of a pre-trained BERT model.</span>
<span class="sd">        output_path (str): The path to the output BERT model (usually fine-tuned).</span>
<span class="sd">        eval_mode (bool): Set to `False` if the model is loaded for training.</span>
<span class="sd">        max_length_for_input (int): The maximum length of an input sequence.</span>
<span class="sd">        num_epochs_for_training (int): The number of epochs for training a BERT model.</span>
<span class="sd">        batch_size_for_training (int): The batch size for training a BERT model.</span>
<span class="sd">        batch_size_for_prediction (int): The batch size for making predictions.</span>
<span class="sd">        training_data (Dataset, optional): Data for training the model if `for_training` is set to `True`. Defaults to `None`.</span>
<span class="sd">        validation_data (Dataset, optional): Data for validating the model if `for_training` is set to `True`. Defaults to `None`.</span>
<span class="sd">        training_args (TrainingArguments, optional): Training arguments for training the model if `for_training` is set to `True`. Defaults to `None`.</span>
<span class="sd">        trainer (Trainer, optional): The model trainer fed with `training_args` and data samples. Defaults to `None`.</span>
<span class="sd">        softmax (torch.nn.SoftMax, optional): The softmax layer used for normalising synonym scores. Defaults to `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loaded_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">eval_mode</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">max_length_for_input</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_epochs_for_training</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size_for_training</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size_for_prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># (sentence1, sentence2, label)</span>
        <span class="n">validation_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Load the pretrained BERT model from the given path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_path</span> <span class="o">=</span> <span class="n">loaded_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading a BERT model from: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loaded_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_path</span><span class="p">,</span> <span class="n">output_hidden_states</span><span class="o">=</span><span class="n">eval_mode</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">loaded_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_mode</span> <span class="o">=</span> <span class="n">eval_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length_for_input</span> <span class="o">=</span> <span class="n">max_length_for_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs_for_training</span> <span class="o">=</span> <span class="n">num_epochs_for_training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size_for_training</span> <span class="o">=</span> <span class="n">batch_size_for_training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size_for_prediction</span> <span class="o">=</span> <span class="n">batch_size_for_prediction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_stat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># load the pre-trained BERT model and set it to eval mode (static)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># load the pre-trained BERT model for fine-tuning</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">training_data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Training data should be provided when `for_training` is `True`.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Validation data should be provided when `for_training` is `True`.&quot;</span><span class="p">)</span>
            <span class="c1"># load data (max_length is used for truncation)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">training_data</span><span class="p">,</span> <span class="s2">&quot;training&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">validation_data</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_stat</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;num_training&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">),</span>
                <span class="s2">&quot;num_validation&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_data</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="c1"># generate training arguments</span>
            <span class="n">epoch_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size_for_training</span>  <span class="c1"># total steps of an epoch</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epoch_steps</span> <span class="o">=</span> <span class="n">epoch_steps</span> <span class="o">//</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span>  <span class="c1"># to deal with multi-gpus case</span>
            <span class="c1"># keep logging steps consisitent even for small batch size</span>
            <span class="c1"># report logging on every 0.02 epoch</span>
            <span class="n">logging_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">epoch_steps</span> <span class="o">*</span> <span class="mf">0.02</span><span class="p">)</span>
            <span class="c1"># eval on every 0.2 epoch</span>
            <span class="n">eval_steps</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">logging_steps</span>
            <span class="c1"># generate the training arguments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span>
                <span class="n">num_train_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_epochs_for_training</span><span class="p">,</span>
                <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size_for_training</span><span class="p">,</span>
                <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size_for_training</span><span class="p">,</span>
                <span class="n">warmup_ratio</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                <span class="n">logging_steps</span><span class="o">=</span><span class="n">logging_steps</span><span class="p">,</span>
                <span class="n">logging_dir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/tensorboard&quot;</span><span class="p">,</span>
                <span class="n">eval_steps</span><span class="o">=</span><span class="n">eval_steps</span><span class="p">,</span>
                <span class="n">evaluation_strategy</span><span class="o">=</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span>
                <span class="n">do_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">do_eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">save_steps</span><span class="o">=</span><span class="n">eval_steps</span><span class="p">,</span>
                <span class="n">save_total_limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># build the trainer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span><span class="p">,</span>
                <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">,</span>
                <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_data</span><span class="p">,</span>
                <span class="n">compute_metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_metrics</span><span class="p">,</span>
                <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">_tokenizer</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume_from_checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start training the BERT model.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Training cannot be started in `eval` mode.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="o">=</span><span class="n">resume_from_checkpoint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;To eval mode.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The BERT model is set to eval mode for making predictions.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># TODO: to implement multi-gpus for inference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">device_num</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sent_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run prediction pipeline for synonym classification.</span>

<span class="sd">        Return the `softmax` probailities of predicting pairs as synonyms (`index=1`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_inputs</span><span class="p">(</span><span class="n">sent_pairs</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Load the list of `(annotation1, annotation2, label)` samples into a `datasets.Dataset`.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">iterate</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;annotation1&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;annotation2&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span>
        <span class="c1"># NOTE: no padding here because the Trainer class supports dynamic padding</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">examples</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">_tokenizer</span><span class="p">(</span>
                <span class="n">examples</span><span class="p">[</span><span class="s2">&quot;annotation1&quot;</span><span class="p">],</span> <span class="n">examples</span><span class="p">[</span><span class="s2">&quot;annotation2&quot;</span><span class="p">],</span> <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length_for_input</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">),</span>
            <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Load </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> data with batch size 1000:&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset</span>

    <span class="k">def</span> <span class="nf">process_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sent_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Process input sentence pairs for the BERT model.</span>

<span class="sd">        Transform the sentences into BERT input embeddings and load them into the device.</span>
<span class="sd">        This function is called only when the BERT model is about to make predictions (`eval` mode).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">_tokenizer</span><span class="p">(</span>
            <span class="n">sent_pairs</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length_for_input</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add more evaluation metrics into the training log.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: currently only accuracy is added, will expect more in the future if needed</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">label_ids</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_device</span><span class="p">(</span><span class="n">device_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a device (GPU or CPU) for the torch model&quot;&quot;&quot;</span>
        <span class="c1"># If there&#39;s a GPU available...</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="c1"># Tell PyTorch to use the GPU.</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cuda:</span><span class="si">{</span><span class="n">device_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">%d</span><span class="s2"> GPU(s) available.&quot;</span> <span class="o">%</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We will use the GPU:&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">(</span><span class="n">device_num</span><span class="p">))</span>
        <span class="c1"># If not...</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No GPU available, using the CPU instead.&quot;</span><span class="p">)</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">device</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seed_val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">888</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set random seed for reproducible results.&quot;&quot;&quot;</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed_val</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed_val</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed_val</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed_val</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.train" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Start training the BERT model.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/bert_classifier.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume_from_checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start training the BERT model.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_mode</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Training cannot be started in `eval` mode.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="o">=</span><span class="n">resume_from_checkpoint</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.eval" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">eval</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>To eval mode.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/bert_classifier.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;To eval mode.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The BERT model is set to eval mode for making predictions.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="c1"># TODO: to implement multi-gpus for inference</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">device_num</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.predict" class="doc doc-heading">
<code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">sent_pairs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Run prediction pipeline for synonym classification.</p>
<p>Return the <code>softmax</code> probailities of predicting pairs as synonyms (<code>index=1</code>).</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/bert_classifier.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sent_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run prediction pipeline for synonym classification.</span>

<span class="sd">    Return the `softmax` probailities of predicting pairs as synonyms (`index=1`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_inputs</span><span class="p">(</span><span class="n">sent_pairs</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.load_dataset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load the list of <code>(annotation1, annotation2, label)</code> samples into a <code>datasets.Dataset</code>.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/bert_classifier.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Load the list of `(annotation1, annotation2, label)` samples into a `datasets.Dataset`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;annotation1&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;annotation2&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span>
    <span class="c1"># NOTE: no padding here because the Trainer class supports dynamic padding</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">examples</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">_tokenizer</span><span class="p">(</span>
            <span class="n">examples</span><span class="p">[</span><span class="s2">&quot;annotation1&quot;</span><span class="p">],</span> <span class="n">examples</span><span class="p">[</span><span class="s2">&quot;annotation2&quot;</span><span class="p">],</span> <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length_for_input</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">),</span>
        <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Load </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> data with batch size 1000:&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.process_inputs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process_inputs</span><span class="p">(</span><span class="n">sent_pairs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Process input sentence pairs for the BERT model.</p>
<p>Transform the sentences into BERT input embeddings and load them into the device.
This function is called only when the BERT model is about to make predictions (<code>eval</code> mode).</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/bert_classifier.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">process_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sent_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Process input sentence pairs for the BERT model.</span>

<span class="sd">    Transform the sentences into BERT input embeddings and load them into the device.</span>
<span class="sd">    This function is called only when the BERT model is about to make predictions (`eval` mode).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">_tokenizer</span><span class="p">(</span>
        <span class="n">sent_pairs</span><span class="p">,</span>
        <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length_for_input</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.compute_metrics" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_metrics</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Add more evaluation metrics into the training log.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/bert_classifier.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add more evaluation metrics into the training log.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: currently only accuracy is added, will expect more in the future if needed</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">label_ids</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.get_device" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_device</span><span class="p">(</span><span class="n">device_num</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get a device (GPU or CPU) for the torch model</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/bert_classifier.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_device</span><span class="p">(</span><span class="n">device_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a device (GPU or CPU) for the torch model&quot;&quot;&quot;</span>
    <span class="c1"># If there&#39;s a GPU available...</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="c1"># Tell PyTorch to use the GPU.</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cuda:</span><span class="si">{</span><span class="n">device_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">%d</span><span class="s2"> GPU(s) available.&quot;</span> <span class="o">%</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We will use the GPU:&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">(</span><span class="n">device_num</span><span class="p">))</span>
    <span class="c1"># If not...</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No GPU available, using the CPU instead.&quot;</span><span class="p">)</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">device</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier.set_seed" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_seed</span><span class="p">(</span><span class="n">seed_val</span><span class="o">=</span><span class="mi">888</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Set random seed for reproducible results.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/bert_classifier.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seed_val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">888</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set random seed for reproducible results.&quot;&quot;&quot;</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed_val</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed_val</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed_val</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed_val</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="deeponto.align.bertmap.mapping_prediction.MappingPredictor" class="doc doc-heading">
        <code>MappingPredictor</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Class for the mapping prediction module of <span class="arithmatex">\(\textsf{BERTMap}\)</span> and <span class="arithmatex">\(\textsf{BERTMapLt}\)</span> models.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tokenizer</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.utils.Tokenizer" href="../../utils/text_utils/#deeponto.utils.text_utils.Tokenizer">Tokenizer</a></code>
          </td>
          <td><p>The tokenizer used for constructing the inverted annotation index and candidate selection.</p></td>
        </tr>
        <tr>
          <td><code>src_annotation_index</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary that stores the <code>(class_iri, class_annotations)</code> pairs from <code>src_onto</code> according to <code>annotation_property_iris</code>.</p></td>
        </tr>
        <tr>
          <td><code>tgt_annotation_index</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary that stores the <code>(class_iri, class_annotations)</code> pairs from <code>tgt_onto</code> according to <code>annotation_property_iris</code>.</p></td>
        </tr>
        <tr>
          <td><code>tgt_inverted_annotation_index</code></td>
          <td>
                <code>InvertedIndex</code>
          </td>
          <td><p>The inverted index built from <code>tgt_annotation_index</code> used for target class candidate selection.</p></td>
        </tr>
        <tr>
          <td><code>bert_synonym_classifier</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier" href="#deeponto.align.bertmap.bert_classifier.BERTSynonymClassifier">BERTSynonymClassifier</a></code>
          </td>
          <td><p>The BERT synonym classifier fine-tuned on text semantics corpora.</p></td>
        </tr>
        <tr>
          <td><code>num_raw_candidates</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The maximum number of selected target class candidates for a source class.</p></td>
        </tr>
        <tr>
          <td><code>num_best_predictions</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The maximum number of best scored mappings presevred for a source class.</p></td>
        </tr>
        <tr>
          <td><code>batch_size_for_prediction</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The batch size of class annotation pairs for computing synonym scores.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>deeponto/align/bertmap/mapping_prediction.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MappingPredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for the mapping prediction module of $\textsf{BERTMap}$ and $\textsf{BERTMapLt}$ models.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        tokenizer (Tokenizer): The tokenizer used for constructing the inverted annotation index and candidate selection.</span>
<span class="sd">        src_annotation_index (dict): A dictionary that stores the `(class_iri, class_annotations)` pairs from `src_onto` according to `annotation_property_iris`.</span>
<span class="sd">        tgt_annotation_index (dict): A dictionary that stores the `(class_iri, class_annotations)` pairs from `tgt_onto` according to `annotation_property_iris`.</span>
<span class="sd">        tgt_inverted_annotation_index (InvertedIndex): The inverted index built from `tgt_annotation_index` used for target class candidate selection.</span>
<span class="sd">        bert_synonym_classifier (BERTSynonymClassifier, optional): The BERT synonym classifier fine-tuned on text semantics corpora.</span>
<span class="sd">        num_raw_candidates (int): The maximum number of selected target class candidates for a source class.</span>
<span class="sd">        num_best_predictions (int): The maximum number of best scored mappings presevred for a source class.</span>
<span class="sd">        batch_size_for_prediction (int): The batch size of class annotation pairs for computing synonym scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tokenizer_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">src_annotation_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tgt_annotation_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">bert_synonym_classifier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BERTSynonymClassifier</span><span class="p">],</span>
        <span class="n">num_raw_candidates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">num_best_predictions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">batch_size_for_prediction</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
        <span class="n">enlighten_manager</span><span class="p">:</span> <span class="n">enlighten</span><span class="o">.</span><span class="n">Manager</span><span class="p">,</span>
        <span class="n">enlighten_status</span><span class="p">:</span> <span class="n">enlighten</span><span class="o">.</span><span class="n">StatusBar</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span> <span class="o">=</span> <span class="n">enlighten_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span> <span class="o">=</span> <span class="n">enlighten_status</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">tokenizer_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Build inverted annotation index for candidate selection.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span> <span class="o">=</span> <span class="n">src_annotation_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_annotation_index</span> <span class="o">=</span> <span class="n">tgt_annotation_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_inverted_annotation_index</span> <span class="o">=</span> <span class="n">Ontology</span><span class="o">.</span><span class="n">build_inverted_annotation_index</span><span class="p">(</span>
            <span class="n">tgt_annotation_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span>
        <span class="p">)</span>
        <span class="c1"># the fundamental judgement for whether bertmap or bertmaplt is loaded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span> <span class="o">=</span> <span class="n">bert_synonym_classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_raw_candidates</span> <span class="o">=</span> <span class="n">num_raw_candidates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span> <span class="o">=</span> <span class="n">num_best_predictions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size_for_prediction</span> <span class="o">=</span> <span class="n">batch_size_for_prediction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_class_mapping</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="n">EntityMapping</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="s2">&quot;&lt;EquivalentTo&gt;&quot;</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bert_mapping_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">src_class_annotations</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">tgt_class_annotations</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;$\textsf{BERTMap}$&#39;s main mapping score module which utilises the fine-tuned BERT synonym</span>
<span class="sd">        classifier.</span>

<span class="sd">        Compute the **synonym score** for each pair of src-tgt class annotations, and return</span>
<span class="sd">        the **average** score as the mapping score. Apply string matching before applying the</span>
<span class="sd">        BERT module to filter easy mappings (with scores $1.0$).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># apply string matching before applying the bert module</span>
        <span class="n">prelim_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_similarity_mapping_score</span><span class="p">(</span>
            <span class="n">src_class_annotations</span><span class="p">,</span>
            <span class="n">tgt_class_annotations</span><span class="p">,</span>
            <span class="n">string_match_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">prelim_score</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prelim_score</span>
        <span class="c1"># apply BERT classifier and define mapping score := Average(SynonymScores)</span>
        <span class="n">class_annotation_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">))</span>
        <span class="n">synonym_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">class_annotation_pairs</span><span class="p">)</span>
        <span class="c1"># only one element tensor is able to be extracted as a scalar by .item()</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">synonym_scores</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">edit_similarity_mapping_score</span><span class="p">(</span>
        <span class="n">src_class_annotations</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">tgt_class_annotations</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">string_match_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;$\textsf{BERTMap}$&#39;s string match module and $\textsf{BERTMapLt}$&#39;s mapping prediction function.</span>

<span class="sd">        Compute the **normalised edit similarity** `(1 - normalised edit distance)` for each pair</span>
<span class="sd">        of src-tgt class annotations, and return the **maximum** score as the mapping score.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># edge case when src and tgt classes have an exact match of annotation</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">tgt_class_annotations</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="c1"># a shortcut to save time for $\textsf{BERTMap}$</span>
        <span class="k">if</span> <span class="n">string_match_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="n">annotation_pairs</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">)</span>
        <span class="n">sim_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">levenshtein</span><span class="o">.</span><span class="n">normalized_similarity</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span> <span class="ow">in</span> <span class="n">annotation_pairs</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">sim_scores</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mapping_prediction_for_src_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_class_iri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">EntityMapping</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Predict $N$ best scored mappings for a source ontology class, where</span>
<span class="sd">        $N$ is specified in `self.num_best_predictions`.</span>

<span class="sd">        1. Apply the **string matching** module to compute &quot;easy&quot; mappings.</span>
<span class="sd">        2. Return the mappings if found any, or if there is no BERT synonym classifier</span>
<span class="sd">        as in $\textsf{BERTMapLt}$.</span>
<span class="sd">        3. If using the BERT synonym classifier module:</span>

<span class="sd">            - Generate batches for class annotation pairs. Each batch contains the combinations of the</span>
<span class="sd">            source class annotations and $M$ target candidate classes&#39; annotations. $M$ is determined</span>
<span class="sd">            by `batch_size_for_prediction`, i.e., stop adding annotations of a target class candidate into</span>
<span class="sd">            the current batch if this operation will cause the size of current batch to exceed the limit.</span>
<span class="sd">            - Compute the synonym scores for each batch and aggregate them into mapping scores; preserve</span>
<span class="sd">            $N$ best scored candidates and update them in the next batch. By this dynamic process, we eventually</span>
<span class="sd">            get $N$ best scored mappings for a source ontology class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">src_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">[</span><span class="n">src_class_iri</span><span class="p">]</span>
        <span class="c1"># previously wrongly put tokenizer again !!!</span>
        <span class="n">tgt_class_candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_inverted_annotation_index</span><span class="o">.</span><span class="n">idf_select</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">),</span> <span class="n">pool_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_raw_candidates</span>
        <span class="p">)</span>  <span class="c1"># [(tgt_class_iri, idf_score)]</span>
        <span class="n">best_scored_mappings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># for string matching: save time if already found string-matched candidates</span>
        <span class="k">def</span> <span class="nf">string_match</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Compute string-matched mappings.&quot;&quot;&quot;</span>
            <span class="n">string_matched_mappings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tgt_candidate_iri</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tgt_class_candidates</span><span class="p">:</span>
                <span class="n">tgt_candidate_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">[</span><span class="n">tgt_candidate_iri</span><span class="p">]</span>
                <span class="n">prelim_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_similarity_mapping_score</span><span class="p">(</span>
                    <span class="n">src_class_annotations</span><span class="p">,</span>
                    <span class="n">tgt_candidate_annotations</span><span class="p">,</span>
                    <span class="n">string_match_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">prelim_score</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="c1"># if src_class_annotations.intersection(tgt_candidate_annotations):</span>
                    <span class="n">string_matched_mappings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">init_class_mapping</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span><span class="p">,</span> <span class="n">prelim_score</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">return</span> <span class="n">string_matched_mappings</span>

        <span class="n">best_scored_mappings</span> <span class="o">+=</span> <span class="n">string_match</span><span class="p">()</span>
        <span class="c1"># return string-matched mappings if found or if there is no bert module (bertmaplt)</span>
        <span class="k">if</span> <span class="n">best_scored_mappings</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best scored class mappings for </span><span class="si">{</span><span class="n">src_class_iri</span><span class="si">}</span><span class="s2"> are</span><span class="se">\n</span><span class="si">{</span><span class="n">best_scored_mappings</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">best_scored_mappings</span>

        <span class="k">def</span> <span class="nf">generate_batched_annotations</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Generate batches of class annotations for the input source class and its</span>
<span class="sd">            target candidates.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># the `nums`` parameter determines how the annotations are grouped</span>
            <span class="n">current_batch</span> <span class="o">=</span> <span class="n">CfgNode</span><span class="p">({</span><span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;nums&quot;</span><span class="p">:</span> <span class="p">[]})</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">tgt_candidate_iri</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tgt_class_candidates</span><span class="p">):</span>
                <span class="n">tgt_candidate_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">[</span><span class="n">tgt_candidate_iri</span><span class="p">]</span>
                <span class="n">annotation_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_candidate_annotations</span><span class="p">))</span>
                <span class="n">current_batch</span><span class="o">.</span><span class="n">annotations</span> <span class="o">+=</span> <span class="n">annotation_pairs</span>
                <span class="n">num_annotation_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation_pairs</span><span class="p">)</span>
                <span class="n">current_batch</span><span class="o">.</span><span class="n">nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_annotation_pairs</span><span class="p">)</span>
                <span class="c1"># collect when the batch is full or for the last target class candidate</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">current_batch</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">batch_size</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tgt_class_candidates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_batch</span><span class="p">)</span>
                    <span class="n">current_batch</span> <span class="o">=</span> <span class="n">CfgNode</span><span class="p">({</span><span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;nums&quot;</span><span class="p">:</span> <span class="p">[]})</span>
            <span class="k">return</span> <span class="n">batches</span>

        <span class="k">def</span> <span class="nf">bert_match</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Compute mappings with fine-tuned BERT synonym classifier.&quot;&quot;&quot;</span>
            <span class="n">bert_matched_mappings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">class_annotation_batches</span> <span class="o">=</span> <span class="n">generate_batched_annotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size_for_prediction</span><span class="p">)</span>
            <span class="n">batch_base_candidate_idx</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">0</span>  <span class="c1"># after each batch, the base index will be increased by # of covered target candidates</span>
            <span class="p">)</span>
            <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">device</span>

            <span class="c1"># intialize N prediction scores and N corresponding indices w.r.t `tgt_class_candidates`</span>
            <span class="n">final_best_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">final_best_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">annotation_batch</span> <span class="ow">in</span> <span class="n">class_annotation_batches</span><span class="p">:</span>

                <span class="n">synonym_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">annotation_batch</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>
                <span class="c1"># aggregating to mappings cores</span>
                <span class="n">grouped_synonym_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                    <span class="n">synonym_scores</span><span class="p">,</span>
                    <span class="n">split_size_or_sections</span><span class="o">=</span><span class="n">annotation_batch</span><span class="o">.</span><span class="n">nums</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mapping_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">grouped_synonym_scores</span><span class="p">])</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping_scores</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation_batch</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span>

                <span class="c1"># preserve N best scored mappings</span>
                <span class="c1"># scale N in case there are less than N tgt candidates in this batch</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mapping_scores</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">)</span>
                <span class="n">batch_best_scores</span><span class="p">,</span> <span class="n">batch_best_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">mapping_scores</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
                <span class="n">batch_best_idxs</span> <span class="o">+=</span> <span class="n">batch_base_candidate_idx</span>

                <span class="c1"># we do the substitution for every batch to prevent from memory overflow</span>
                <span class="n">final_best_scores</span><span class="p">,</span> <span class="n">_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_best_scores</span><span class="p">,</span> <span class="n">final_best_scores</span><span class="p">]),</span>
                    <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">final_best_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_best_idxs</span><span class="p">,</span> <span class="n">final_best_idxs</span><span class="p">])[</span><span class="n">_idxs</span><span class="p">]</span>

                <span class="c1"># update the index for target candidate classes</span>
                <span class="n">batch_base_candidate_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation_batch</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">candidate_idx</span><span class="p">,</span> <span class="n">mapping_score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">final_best_idxs</span><span class="p">,</span> <span class="n">final_best_scores</span><span class="p">):</span>
                <span class="c1"># ignore intial values (-1.0) for dummy mappings</span>
                <span class="c1"># the threshold 0.9 is for mapping extension</span>
                <span class="k">if</span> <span class="n">mapping_score</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.9</span><span class="p">:</span>
                    <span class="n">tgt_candidate_iri</span> <span class="o">=</span> <span class="n">tgt_class_candidates</span><span class="p">[</span><span class="n">candidate_idx</span><span class="o">.</span><span class="n">item</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bert_matched_mappings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">init_class_mapping</span><span class="p">(</span>
                            <span class="n">src_class_iri</span><span class="p">,</span>
                            <span class="n">tgt_candidate_iri</span><span class="p">,</span>
                            <span class="n">mapping_score</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bert_matched_mappings</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best scored class mappings for </span><span class="si">{</span><span class="n">src_class_iri</span><span class="si">}</span><span class="s2"> are</span><span class="se">\n</span><span class="si">{</span><span class="n">bert_matched_mappings</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bert_matched_mappings</span>

        <span class="k">return</span> <span class="n">bert_match</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">mapping_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Apply global matching for each class in the source ontology.</span>

<span class="sd">        See [`mapping_prediction_for_src_class`][deeponto.align.bertmap.mapping_prediction.MappingPredictor.mapping_prediction_for_src_class].</span>

<span class="sd">        If this process is accidentally stopped, it can be resumed from already saved predictions. The progress</span>
<span class="sd">        bar keeps track of the number of source ontology classes that have been matched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start global matching for each class in the source ontology.&quot;</span><span class="p">)</span>

        <span class="n">match_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mapping_index</span> <span class="o">=</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match_dir</span><span class="p">,</span> <span class="s2">&quot;raw_mappings.json&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load the existing mapping prediction file.&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mapping_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="n">match_dir</span><span class="p">)</span>

        <span class="n">progress_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Mapping Prediction&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;per src class&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Prediction&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src_class_iri</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">src_class_iri</span> <span class="ow">in</span> <span class="n">mapping_index</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] Skip matching </span><span class="si">{</span><span class="n">src_class_iri</span><span class="si">}</span><span class="s2"> as already computed.&quot;</span><span class="p">)</span>
                <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="n">mappings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_prediction_for_src_class</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">)</span>
            <span class="n">mapping_index</span><span class="p">[</span><span class="n">src_class_iri</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">with_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">mapping_index</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match_dir</span><span class="p">,</span> <span class="s2">&quot;raw_mappings.json&quot;</span><span class="p">))</span>
                <span class="c1"># also save a .tsv version</span>
                <span class="n">mapping_in_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">mapping_index</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="n">mapping_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mapping_in_tuples</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SrcEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;TgtEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;Score&quot;</span><span class="p">])</span>
                <span class="n">mapping_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match_dir</span><span class="p">,</span> <span class="s2">&quot;raw_mappings.tsv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Save currently computed mappings to prevent undesirable loss.&quot;</span><span class="p">)</span>

            <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished mapping prediction for each class in the source ontology.&quot;</span><span class="p">)</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.mapping_prediction.MappingPredictor.bert_mapping_score" class="doc doc-heading">
<code class="highlight language-python"><span class="n">bert_mapping_score</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p><span class="arithmatex">\(\textsf{BERTMap}\)</span>'s main mapping score module which utilises the fine-tuned BERT synonym
classifier.</p>
<p>Compute the <strong>synonym score</strong> for each pair of src-tgt class annotations, and return
the <strong>average</strong> score as the mapping score. Apply string matching before applying the
BERT module to filter easy mappings (with scores <span class="arithmatex">\(1.0\)</span>).</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/mapping_prediction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">bert_mapping_score</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">src_class_annotations</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">tgt_class_annotations</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;$\textsf{BERTMap}$&#39;s main mapping score module which utilises the fine-tuned BERT synonym</span>
<span class="sd">    classifier.</span>

<span class="sd">    Compute the **synonym score** for each pair of src-tgt class annotations, and return</span>
<span class="sd">    the **average** score as the mapping score. Apply string matching before applying the</span>
<span class="sd">    BERT module to filter easy mappings (with scores $1.0$).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># apply string matching before applying the bert module</span>
    <span class="n">prelim_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_similarity_mapping_score</span><span class="p">(</span>
        <span class="n">src_class_annotations</span><span class="p">,</span>
        <span class="n">tgt_class_annotations</span><span class="p">,</span>
        <span class="n">string_match_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">prelim_score</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">prelim_score</span>
    <span class="c1"># apply BERT classifier and define mapping score := Average(SynonymScores)</span>
    <span class="n">class_annotation_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">))</span>
    <span class="n">synonym_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">class_annotation_pairs</span><span class="p">)</span>
    <span class="c1"># only one element tensor is able to be extracted as a scalar by .item()</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">synonym_scores</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.mapping_prediction.MappingPredictor.edit_similarity_mapping_score" class="doc doc-heading">
<code class="highlight language-python"><span class="n">edit_similarity_mapping_score</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">,</span> <span class="n">string_match_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p><span class="arithmatex">\(\textsf{BERTMap}\)</span>'s string match module and <span class="arithmatex">\(\textsf{BERTMapLt}\)</span>'s mapping prediction function.</p>
<p>Compute the <strong>normalised edit similarity</strong> <code>(1 - normalised edit distance)</code> for each pair
of src-tgt class annotations, and return the <strong>maximum</strong> score as the mapping score.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/mapping_prediction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">edit_similarity_mapping_score</span><span class="p">(</span>
    <span class="n">src_class_annotations</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">tgt_class_annotations</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">string_match_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;$\textsf{BERTMap}$&#39;s string match module and $\textsf{BERTMapLt}$&#39;s mapping prediction function.</span>

<span class="sd">    Compute the **normalised edit similarity** `(1 - normalised edit distance)` for each pair</span>
<span class="sd">    of src-tgt class annotations, and return the **maximum** score as the mapping score.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># edge case when src and tgt classes have an exact match of annotation</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">tgt_class_annotations</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>
    <span class="c1"># a shortcut to save time for $\textsf{BERTMap}$</span>
    <span class="k">if</span> <span class="n">string_match_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="n">annotation_pairs</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_class_annotations</span><span class="p">)</span>
    <span class="n">sim_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">levenshtein</span><span class="o">.</span><span class="n">normalized_similarity</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span> <span class="ow">in</span> <span class="n">annotation_pairs</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">sim_scores</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.mapping_prediction.MappingPredictor.mapping_prediction_for_src_class" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mapping_prediction_for_src_class</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Predict <span class="arithmatex">\(N\)</span> best scored mappings for a source ontology class, where
<span class="arithmatex">\(N\)</span> is specified in <code>self.num_best_predictions</code>.</p>
<ol>
<li>Apply the <strong>string matching</strong> module to compute "easy" mappings.</li>
<li>Return the mappings if found any, or if there is no BERT synonym classifier
as in <span class="arithmatex">\(\textsf{BERTMapLt}\)</span>.</li>
<li>
<p>If using the BERT synonym classifier module:</p>
<ul>
<li>Generate batches for class annotation pairs. Each batch contains the combinations of the
source class annotations and <span class="arithmatex">\(M\)</span> target candidate classes' annotations. <span class="arithmatex">\(M\)</span> is determined
by <code>batch_size_for_prediction</code>, i.e., stop adding annotations of a target class candidate into
the current batch if this operation will cause the size of current batch to exceed the limit.</li>
<li>Compute the synonym scores for each batch and aggregate them into mapping scores; preserve
<span class="arithmatex">\(N\)</span> best scored candidates and update them in the next batch. By this dynamic process, we eventually
get <span class="arithmatex">\(N\)</span> best scored mappings for a source ontology class.</li>
</ul>
</li>
</ol>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/mapping_prediction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mapping_prediction_for_src_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_class_iri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">EntityMapping</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Predict $N$ best scored mappings for a source ontology class, where</span>
<span class="sd">    $N$ is specified in `self.num_best_predictions`.</span>

<span class="sd">    1. Apply the **string matching** module to compute &quot;easy&quot; mappings.</span>
<span class="sd">    2. Return the mappings if found any, or if there is no BERT synonym classifier</span>
<span class="sd">    as in $\textsf{BERTMapLt}$.</span>
<span class="sd">    3. If using the BERT synonym classifier module:</span>

<span class="sd">        - Generate batches for class annotation pairs. Each batch contains the combinations of the</span>
<span class="sd">        source class annotations and $M$ target candidate classes&#39; annotations. $M$ is determined</span>
<span class="sd">        by `batch_size_for_prediction`, i.e., stop adding annotations of a target class candidate into</span>
<span class="sd">        the current batch if this operation will cause the size of current batch to exceed the limit.</span>
<span class="sd">        - Compute the synonym scores for each batch and aggregate them into mapping scores; preserve</span>
<span class="sd">        $N$ best scored candidates and update them in the next batch. By this dynamic process, we eventually</span>
<span class="sd">        get $N$ best scored mappings for a source ontology class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">src_class_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">[</span><span class="n">src_class_iri</span><span class="p">]</span>
    <span class="c1"># previously wrongly put tokenizer again !!!</span>
    <span class="n">tgt_class_candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_inverted_annotation_index</span><span class="o">.</span><span class="n">idf_select</span><span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">),</span> <span class="n">pool_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_raw_candidates</span>
    <span class="p">)</span>  <span class="c1"># [(tgt_class_iri, idf_score)]</span>
    <span class="n">best_scored_mappings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># for string matching: save time if already found string-matched candidates</span>
    <span class="k">def</span> <span class="nf">string_match</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute string-matched mappings.&quot;&quot;&quot;</span>
        <span class="n">string_matched_mappings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tgt_candidate_iri</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tgt_class_candidates</span><span class="p">:</span>
            <span class="n">tgt_candidate_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">[</span><span class="n">tgt_candidate_iri</span><span class="p">]</span>
            <span class="n">prelim_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_similarity_mapping_score</span><span class="p">(</span>
                <span class="n">src_class_annotations</span><span class="p">,</span>
                <span class="n">tgt_candidate_annotations</span><span class="p">,</span>
                <span class="n">string_match_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">prelim_score</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># if src_class_annotations.intersection(tgt_candidate_annotations):</span>
                <span class="n">string_matched_mappings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init_class_mapping</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span><span class="p">,</span> <span class="n">prelim_score</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">string_matched_mappings</span>

    <span class="n">best_scored_mappings</span> <span class="o">+=</span> <span class="n">string_match</span><span class="p">()</span>
    <span class="c1"># return string-matched mappings if found or if there is no bert module (bertmaplt)</span>
    <span class="k">if</span> <span class="n">best_scored_mappings</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best scored class mappings for </span><span class="si">{</span><span class="n">src_class_iri</span><span class="si">}</span><span class="s2"> are</span><span class="se">\n</span><span class="si">{</span><span class="n">best_scored_mappings</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_scored_mappings</span>

    <span class="k">def</span> <span class="nf">generate_batched_annotations</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate batches of class annotations for the input source class and its</span>
<span class="sd">        target candidates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># the `nums`` parameter determines how the annotations are grouped</span>
        <span class="n">current_batch</span> <span class="o">=</span> <span class="n">CfgNode</span><span class="p">({</span><span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;nums&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">tgt_candidate_iri</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tgt_class_candidates</span><span class="p">):</span>
            <span class="n">tgt_candidate_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">[</span><span class="n">tgt_candidate_iri</span><span class="p">]</span>
            <span class="n">annotation_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_annotations</span><span class="p">,</span> <span class="n">tgt_candidate_annotations</span><span class="p">))</span>
            <span class="n">current_batch</span><span class="o">.</span><span class="n">annotations</span> <span class="o">+=</span> <span class="n">annotation_pairs</span>
            <span class="n">num_annotation_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation_pairs</span><span class="p">)</span>
            <span class="n">current_batch</span><span class="o">.</span><span class="n">nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_annotation_pairs</span><span class="p">)</span>
            <span class="c1"># collect when the batch is full or for the last target class candidate</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">current_batch</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">batch_size</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tgt_class_candidates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_batch</span><span class="p">)</span>
                <span class="n">current_batch</span> <span class="o">=</span> <span class="n">CfgNode</span><span class="p">({</span><span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;nums&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">return</span> <span class="n">batches</span>

    <span class="k">def</span> <span class="nf">bert_match</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute mappings with fine-tuned BERT synonym classifier.&quot;&quot;&quot;</span>
        <span class="n">bert_matched_mappings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">class_annotation_batches</span> <span class="o">=</span> <span class="n">generate_batched_annotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size_for_prediction</span><span class="p">)</span>
        <span class="n">batch_base_candidate_idx</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">0</span>  <span class="c1"># after each batch, the base index will be increased by # of covered target candidates</span>
        <span class="p">)</span>
        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">device</span>

        <span class="c1"># intialize N prediction scores and N corresponding indices w.r.t `tgt_class_candidates`</span>
        <span class="n">final_best_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">final_best_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">annotation_batch</span> <span class="ow">in</span> <span class="n">class_annotation_batches</span><span class="p">:</span>

            <span class="n">synonym_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_synonym_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">annotation_batch</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>
            <span class="c1"># aggregating to mappings cores</span>
            <span class="n">grouped_synonym_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="n">synonym_scores</span><span class="p">,</span>
                <span class="n">split_size_or_sections</span><span class="o">=</span><span class="n">annotation_batch</span><span class="o">.</span><span class="n">nums</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mapping_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">grouped_synonym_scores</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping_scores</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation_batch</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span>

            <span class="c1"># preserve N best scored mappings</span>
            <span class="c1"># scale N in case there are less than N tgt candidates in this batch</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mapping_scores</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">)</span>
            <span class="n">batch_best_scores</span><span class="p">,</span> <span class="n">batch_best_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">mapping_scores</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
            <span class="n">batch_best_idxs</span> <span class="o">+=</span> <span class="n">batch_base_candidate_idx</span>

            <span class="c1"># we do the substitution for every batch to prevent from memory overflow</span>
            <span class="n">final_best_scores</span><span class="p">,</span> <span class="n">_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_best_scores</span><span class="p">,</span> <span class="n">final_best_scores</span><span class="p">]),</span>
                <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">final_best_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_best_idxs</span><span class="p">,</span> <span class="n">final_best_idxs</span><span class="p">])[</span><span class="n">_idxs</span><span class="p">]</span>

            <span class="c1"># update the index for target candidate classes</span>
            <span class="n">batch_base_candidate_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation_batch</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">candidate_idx</span><span class="p">,</span> <span class="n">mapping_score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">final_best_idxs</span><span class="p">,</span> <span class="n">final_best_scores</span><span class="p">):</span>
            <span class="c1"># ignore intial values (-1.0) for dummy mappings</span>
            <span class="c1"># the threshold 0.9 is for mapping extension</span>
            <span class="k">if</span> <span class="n">mapping_score</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.9</span><span class="p">:</span>
                <span class="n">tgt_candidate_iri</span> <span class="o">=</span> <span class="n">tgt_class_candidates</span><span class="p">[</span><span class="n">candidate_idx</span><span class="o">.</span><span class="n">item</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">bert_matched_mappings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init_class_mapping</span><span class="p">(</span>
                        <span class="n">src_class_iri</span><span class="p">,</span>
                        <span class="n">tgt_candidate_iri</span><span class="p">,</span>
                        <span class="n">mapping_score</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bert_matched_mappings</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_best_predictions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best scored class mappings for </span><span class="si">{</span><span class="n">src_class_iri</span><span class="si">}</span><span class="s2"> are</span><span class="se">\n</span><span class="si">{</span><span class="n">bert_matched_mappings</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bert_matched_mappings</span>

    <span class="k">return</span> <span class="n">bert_match</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.mapping_prediction.MappingPredictor.mapping_prediction" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mapping_prediction</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Apply global matching for each class in the source ontology.</p>
<p>See <a class="autorefs autorefs-internal" href="#deeponto.align.bertmap.mapping_prediction.MappingPredictor.mapping_prediction_for_src_class"><code>mapping_prediction_for_src_class</code></a>.</p>
<p>If this process is accidentally stopped, it can be resumed from already saved predictions. The progress
bar keeps track of the number of source ontology classes that have been matched.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/mapping_prediction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mapping_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Apply global matching for each class in the source ontology.</span>

<span class="sd">    See [`mapping_prediction_for_src_class`][deeponto.align.bertmap.mapping_prediction.MappingPredictor.mapping_prediction_for_src_class].</span>

<span class="sd">    If this process is accidentally stopped, it can be resumed from already saved predictions. The progress</span>
<span class="sd">    bar keeps track of the number of source ontology classes that have been matched.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start global matching for each class in the source ontology.&quot;</span><span class="p">)</span>

    <span class="n">match_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mapping_index</span> <span class="o">=</span> <span class="n">FileUtils</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match_dir</span><span class="p">,</span> <span class="s2">&quot;raw_mappings.json&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load the existing mapping prediction file.&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">mapping_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="n">match_dir</span><span class="p">)</span>

    <span class="n">progress_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Mapping Prediction&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;per src class&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Prediction&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src_class_iri</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">src_class_iri</span> <span class="ow">in</span> <span class="n">mapping_index</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] Skip matching </span><span class="si">{</span><span class="n">src_class_iri</span><span class="si">}</span><span class="s2"> as already computed.&quot;</span><span class="p">)</span>
            <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">continue</span>
        <span class="n">mappings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_prediction_for_src_class</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">)</span>
        <span class="n">mapping_index</span><span class="p">[</span><span class="n">src_class_iri</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">with_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">FileUtils</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">mapping_index</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match_dir</span><span class="p">,</span> <span class="s2">&quot;raw_mappings.json&quot;</span><span class="p">))</span>
            <span class="c1"># also save a .tsv version</span>
            <span class="n">mapping_in_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">mapping_index</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">mapping_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mapping_in_tuples</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SrcEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;TgtEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;Score&quot;</span><span class="p">])</span>
            <span class="n">mapping_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match_dir</span><span class="p">,</span> <span class="s2">&quot;raw_mappings.tsv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Save currently computed mappings to prevent undesirable loss.&quot;</span><span class="p">)</span>

        <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished mapping prediction for each class in the source ontology.&quot;</span><span class="p">)</span>
    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="deeponto.align.bertmap.mapping_refinement.MappingRefiner" class="doc doc-heading">
        <code>MappingRefiner</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Class for the mapping refinement module of <span class="arithmatex">\(\textsf{BERTMap}\)</span>.</p>
<p><span class="arithmatex">\(\textsf{BERTMapLt}\)</span> does not go through mapping refinement for its being "light".
All the attributes of this class are supposed to be passed from <code>BERTMapPipeline</code>.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The source ontology to be matched.</p></td>
        </tr>
        <tr>
          <td><code>tgt_onto</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.onto.Ontology" href="../../onto/#deeponto.onto.ontology.Ontology">Ontology</a></code>
          </td>
          <td><p>The target ontology to be matched.</p></td>
        </tr>
        <tr>
          <td><code>mapping_predictor</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="deeponto.align.bertmap.mapping_prediction.MappingPredictor" href="#deeponto.align.bertmap.mapping_prediction.MappingPredictor">MappingPredictor</a></code>
          </td>
          <td><p>The mapping prediction module of BERTMap.</p></td>
        </tr>
        <tr>
          <td><code>mapping_extension_threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Mappings with scores <span class="arithmatex">\(\geq\)</span> this value will be considered in the iterative mapping extension process.</p></td>
        </tr>
        <tr>
          <td><code>raw_mappings</code></td>
          <td>
                <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="deeponto.align.mapping.EntityMapping" href="../mapping/#deeponto.align.mapping.EntityMapping">EntityMapping</a>]</code>
          </td>
          <td><p>List of <strong>raw class mappings</strong> predicted in the <strong>global matching</strong> phase.</p></td>
        </tr>
        <tr>
          <td><code>mapping_score_dict</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dynamic dictionary that keeps track of mappings (with scores) that have already been computed.</p></td>
        </tr>
        <tr>
          <td><code>mapping_filter_threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Mappings with scores <span class="arithmatex">\(\geq\)</span> this value will be preserved for the final mapping repairing.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>deeponto/align/bertmap/mapping_refinement.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MappingRefiner</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for the mapping refinement module of $\textsf{BERTMap}$.</span>

<span class="sd">    $\textsf{BERTMapLt}$ does not go through mapping refinement for its being &quot;light&quot;.</span>
<span class="sd">    All the attributes of this class are supposed to be passed from `BERTMapPipeline`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        src_onto (Ontology): The source ontology to be matched.</span>
<span class="sd">        tgt_onto (Ontology): The target ontology to be matched.</span>
<span class="sd">        mapping_predictor (MappingPredictor): The mapping prediction module of BERTMap.</span>
<span class="sd">        mapping_extension_threshold (float): Mappings with scores $\geq$ this value will be considered in the iterative mapping extension process.</span>
<span class="sd">        raw_mappings (List[EntityMapping]): List of **raw class mappings** predicted in the **global matching** phase.</span>
<span class="sd">        mapping_score_dict (dict): A dynamic dictionary that keeps track of mappings (with scores) that have already been computed.</span>
<span class="sd">        mapping_filter_threshold (float): Mappings with scores $\geq$ this value will be preserved for the final mapping repairing. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">src_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span>
        <span class="n">tgt_onto</span><span class="p">:</span> <span class="n">Ontology</span><span class="p">,</span>
        <span class="n">mapping_predictor</span><span class="p">:</span> <span class="n">MappingPredictor</span><span class="p">,</span>
        <span class="n">mapping_extension_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">mapping_filtered_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
        <span class="n">enlighten_manager</span><span class="p">:</span> <span class="n">enlighten</span><span class="o">.</span><span class="n">Manager</span><span class="p">,</span>
        <span class="n">enlighten_status</span><span class="p">:</span> <span class="n">enlighten</span><span class="o">.</span><span class="n">StatusBar</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span> <span class="o">=</span> <span class="n">enlighten_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span> <span class="o">=</span> <span class="n">enlighten_status</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span> <span class="o">=</span> <span class="n">src_onto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span> <span class="o">=</span> <span class="n">tgt_onto</span>

        <span class="c1"># iterative mapping extension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span> <span class="o">=</span> <span class="n">mapping_predictor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_extension_threshold</span> <span class="o">=</span> <span class="n">mapping_extension_threshold</span>  <span class="c1"># \kappa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_mappings</span> <span class="o">=</span> <span class="n">EntityMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span> <span class="s2">&quot;raw_mappings.tsv&quot;</span><span class="p">),</span>
            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_extension_threshold</span><span class="p">,</span>
            <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;&lt;EquivalentTo&gt;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># keep track of already scored mappings to prevent duplicated predictions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_score_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_mappings</span><span class="p">:</span>
            <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">with_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_score_dict</span><span class="p">[(</span><span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span><span class="p">)]</span> <span class="o">=</span> <span class="n">score</span>

        <span class="c1"># the threshold for final filtering the extended mappings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_filtered_threshold</span> <span class="o">=</span> <span class="n">mapping_filtered_threshold</span>  <span class="c1"># \lambda</span>

        <span class="c1"># logmap mapping repair folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span> <span class="s2">&quot;logmap-repair&quot;</span><span class="p">)</span>

        <span class="c1"># paths for mapping extension and repair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extended_mapping_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span> <span class="s2">&quot;extended_mappings.tsv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span> <span class="s2">&quot;filtered_mappings.tsv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repaired_mapping_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span> <span class="s2">&quot;repaired_mappings.tsv&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mapping_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Iterative mapping extension based on the locality principle.</span>

<span class="sd">        For each class pair $(c, c&#39;)$ (scored in the global matching phase) with score </span>
<span class="sd">        $\geq \kappa$, search for plausible mappings between the parents of $c$ and $c&#39;$,</span>
<span class="sd">        and between the children of $c$ and $c&#39;$. This is an iterative process as the set </span>
<span class="sd">        newly discovered mappings can act renew the frontier for searching. Terminate if</span>
<span class="sd">        no new mappings with score $\geq \kappa$ can be found or the limit `max_iter` has </span>
<span class="sd">        been reached. Note that $\kappa$ is set to $0.9$ by default (can be altered</span>
<span class="sd">        in the configuration file). The mapping extension progress bar keeps track of the </span>
<span class="sd">        total number of extended mappings (including the previously predicted ones).</span>

<span class="sd">        A further filtering will be performed by only preserving mappings with score $\geq \lambda$,</span>
<span class="sd">        in the original BERTMap paper, $\lambda$ is determined by the validation mappings, but</span>
<span class="sd">        in practice $\lambda$ is not a sensitive hyperparameter and validation mappings are often</span>
<span class="sd">        not available. Therefore, we manually set $\lambda$ to $0.9995$ by default (can be altered</span>
<span class="sd">        in the configuration file). The mapping filtering progress bar keeps track of the </span>
<span class="sd">        total number of filtered mappings (this bar is purely for logging purpose).</span>

<span class="sd">        Args:</span>
<span class="sd">            max_iter (int, optional): The maximum number of mapping extension iterations. Defaults to `10`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">num_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Extension&quot;</span><span class="p">)</span>
        <span class="n">extension_progress_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mapping Extension [Iteration #</span><span class="si">{</span><span class="n">num_iter</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mapping&quot;</span>
        <span class="p">)</span>
        <span class="n">filtering_progress_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mapping Filtering&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mapping&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extended_mapping_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found extended and filtered mapping files at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extended_mapping_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Please check file integrity; if incomplete, &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;delete them and re-run the program.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># for animation purposes</span>
            <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mapping Extension&quot;</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">EntityMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extended_mapping_path</span><span class="p">):</span>
                <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Filtering&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">EntityMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="p">):</span>
                <span class="n">filtering_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">filtering_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">return</span>
        <span class="c1"># intialise the frontier, explored, final expansion sets with the raw mappings</span>
        <span class="c1"># NOTE be careful of address pointers</span>
        <span class="n">frontier</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_mappings</span><span class="p">]</span>
        <span class="n">expansion</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">with_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_mappings</span><span class="p">]</span>
        <span class="c1"># for animation purposes</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expansion</span><span class="p">)):</span>
            <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Start mapping extension for each class pair with score &gt;= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_extension_threshold</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="n">frontier</span> <span class="ow">and</span> <span class="n">num_iter</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
            <span class="n">new_mappings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span> <span class="ow">in</span> <span class="n">frontier</span><span class="p">:</span>
                <span class="c1"># one hop extension makes sure new mappings are really &quot;new&quot;</span>
                <span class="n">cur_new_mappings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_hop_extend</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span><span class="p">)</span>
                <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cur_new_mappings</span><span class="p">))</span>
                <span class="n">new_mappings</span> <span class="o">+=</span> <span class="n">cur_new_mappings</span>
            <span class="c1"># add new mappings to the expansion set</span>
            <span class="n">expansion</span> <span class="o">+=</span> <span class="n">new_mappings</span>
            <span class="c1"># renew frontier with the newly discovered mappings</span>
            <span class="n">frontier</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">new_mappings</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Add </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_mappings</span><span class="p">)</span><span class="si">}</span><span class="s2"> mappings at iteration #</span><span class="si">{</span><span class="n">num_iter</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">num_iter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mapping Extension [Iteration #</span><span class="si">{</span><span class="n">num_iter</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">num_extended</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_mappings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Finished iterative mapping extension with </span><span class="si">{</span><span class="n">num_extended</span><span class="si">}</span><span class="s2"> new mappings and in total </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span><span class="si">}</span><span class="s2"> extended mappings.&quot;</span>
        <span class="p">)</span>

        <span class="n">extended_mapping_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SrcEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;TgtEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;Score&quot;</span><span class="p">])</span>
        <span class="n">extended_mapping_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extended_mapping_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Filtering&quot;</span><span class="p">)</span>

        <span class="n">filtered_expansion</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">expansion</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_filtered_threshold</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Filtered the extended mappings by a threshold of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_filtered_threshold</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_expansion</span><span class="p">)</span><span class="si">}</span><span class="s2"> mappings left for mapping repair.&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_expansion</span><span class="p">)):</span>
            <span class="n">filtering_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="n">filtered_mapping_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">filtered_expansion</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SrcEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;TgtEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;Score&quot;</span><span class="p">])</span>
        <span class="n">filtered_mapping_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">filtering_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filtered_expansion</span>

    <span class="k">def</span> <span class="nf">one_hop_extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_class_iri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tgt_class_iri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Extend mappings from a scored class pair $(c, c&#39;)$ by</span>
<span class="sd">        searching from one-hop neighbors.</span>

<span class="sd">        Search for plausible mappings between the parents of $c$ and $c&#39;$,</span>
<span class="sd">        and between the children of $c$ and $c&#39;$. Mappings that are not</span>
<span class="sd">        already computed (recorded in `self.mapping_score_dict`) and have</span>
<span class="sd">        a score $\geq `self.mapping_extension_threshold` will be returned as</span>
<span class="sd">        **new** mappings.</span>

<span class="sd">        Args:</span>
<span class="sd">            src_class_iri (str): The IRI of the source ontology class $c$.</span>
<span class="sd">            tgt_class_iri (str): The IRI of the target ontology class $c&#39;$.</span>
<span class="sd">            pool_size (int, optional): The maximum number of plausible mappings to be extended. Defaults to 200.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[EntityMapping]): A list of one-hop extended mappings.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">src_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">get_owl_object_from_iri</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">)</span>
        <span class="n">src_class_parent_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">reasoner</span><span class="o">.</span><span class="n">super_entities_of</span><span class="p">(</span><span class="n">src_class</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">src_class_children_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">reasoner</span><span class="o">.</span><span class="n">sub_entities_of</span><span class="p">(</span><span class="n">src_class</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">tgt_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">get_owl_object_from_iri</span><span class="p">(</span><span class="n">tgt_class_iri</span><span class="p">)</span>
        <span class="n">tgt_class_parent_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">reasoner</span><span class="o">.</span><span class="n">super_entities_of</span><span class="p">(</span><span class="n">tgt_class</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tgt_class_children_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">reasoner</span><span class="o">.</span><span class="n">sub_entities_of</span><span class="p">(</span><span class="n">tgt_class</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># pair up parents and children, respectively; NOTE set() might not be necessary</span>
        <span class="n">parent_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_parent_iris</span><span class="p">,</span> <span class="n">tgt_class_parent_iris</span><span class="p">)))</span>
        <span class="n">children_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_children_iris</span><span class="p">,</span> <span class="n">tgt_class_children_iris</span><span class="p">)))</span>

        <span class="n">candidate_pairs</span> <span class="o">=</span> <span class="n">parent_pairs</span> <span class="o">+</span> <span class="n">children_pairs</span>
        <span class="c1"># downsample if the number of candidates is too large</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pool_size</span><span class="p">:</span>
            <span class="n">candidate_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">candidate_pairs</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">)</span>

        <span class="n">extended_mappings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">src_candidate_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span> <span class="ow">in</span> <span class="n">parent_pairs</span> <span class="o">+</span> <span class="n">children_pairs</span><span class="p">:</span>

            <span class="c1"># if already computed meaning that it is not a new mapping</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">src_candidate_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_score_dict</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">src_candidate_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">[</span><span class="n">src_candidate_iri</span><span class="p">]</span>
            <span class="n">tgt_candidate_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">[</span><span class="n">tgt_candidate_iri</span><span class="p">]</span>
            <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">bert_mapping_score</span><span class="p">(</span><span class="n">src_candidate_annotations</span><span class="p">,</span> <span class="n">tgt_candidate_annotations</span><span class="p">)</span>
            <span class="c1"># add to already scored collection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_score_dict</span><span class="p">[(</span><span class="n">src_candidate_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span><span class="p">)]</span> <span class="o">=</span> <span class="n">score</span>

            <span class="c1"># skip mappings with low scores</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_extension_threshold</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">extended_mappings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">src_candidate_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;New mappings (in tuples) extended from </span><span class="si">{</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">,</span><span class="w"> </span><span class="n">tgt_class_iri</span><span class="p">)</span><span class="si">}</span><span class="s2"> are:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extended_mappings</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">extended_mappings</span>

    <span class="k">def</span> <span class="nf">mapping_repair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Repair the filtered mappings with LogMap&#39;s debugger.</span>

<span class="sd">        !!! note</span>

<span class="sd">            A sub-folder under `match` named `logmap-repair` contains LogMap-related intermediate files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># progress bar for animation purposes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Repairing&quot;</span><span class="p">)</span>
        <span class="n">repair_progress_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mapping Repairing&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mapping&quot;</span>
        <span class="p">)</span>

        <span class="c1"># skip repairing if already found the file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repaired_mapping_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found the repaired mapping file at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repaired_mapping_path</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Please check file integrity; if incomplete, &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;delete it and re-run the program.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># update progress bar for animation purposes</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">EntityMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repaired_mapping_path</span><span class="p">):</span>
                <span class="n">repair_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">repair_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> 

        <span class="c1"># start mapping repair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Repair the filtered mappings with LogMap debugger.&quot;</span><span class="p">)</span>
        <span class="c1"># formatting the filtered mappings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_formatting</span><span class="p">()</span>

        <span class="c1"># run the LogMap repair module on the extended mappings</span>
        <span class="n">run_logmap_repair</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">owl_path</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">owl_path</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;filtered_mappings_for_LogMap_repair.txt&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># create table mappings from LogMap repair outputs</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">,</span> <span class="s2">&quot;mappings_repaired_with_LogMap.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span> <span class="s2">&quot;repaired_mappings.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;SrcEntity</span><span class="se">\t</span><span class="s2">TgtEntity</span><span class="se">\t</span><span class="s2">Score</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">src_ent_iri</span><span class="p">,</span> <span class="n">tgt_ent_iri</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_ent_iri</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tgt_ent_iri</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">repair_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mapping repair finished.&quot;</span><span class="p">)</span>
        <span class="n">repair_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">logmap_repair_formatting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the filtered mapping file into the LogMap format.</span>

<span class="sd">        An auxiliary function of the mapping repair module which requires mappings</span>
<span class="sd">        to be formatted as LogMap&#39;s input format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read the filtered mapping file and convert to tuples</span>
        <span class="n">filtered_mappings</span> <span class="o">=</span> <span class="n">EntityMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="p">)</span>
        <span class="n">filtered_mappings_in_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">with_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">filtered_mappings</span><span class="p">]</span>

        <span class="c1"># write the mappings into logmap format</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">filtered_mappings_in_tuples</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_class_iri</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">tgt_class_iri</span><span class="si">}</span><span class="s2">|=|</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">|CLS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># create a path to prevent error</span>
        <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">)</span>
        <span class="n">formatted_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;filtered_mappings_for_LogMap_repair.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">formatted_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lines</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.mapping_refinement.MappingRefiner.mapping_extension" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mapping_extension</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Iterative mapping extension based on the locality principle.</p>
<p>For each class pair <span class="arithmatex">\((c, c')\)</span> (scored in the global matching phase) with score 
<span class="arithmatex">\(\geq \kappa\)</span>, search for plausible mappings between the parents of <span class="arithmatex">\(c\)</span> and <span class="arithmatex">\(c'\)</span>,
and between the children of <span class="arithmatex">\(c\)</span> and <span class="arithmatex">\(c'\)</span>. This is an iterative process as the set 
newly discovered mappings can act renew the frontier for searching. Terminate if
no new mappings with score <span class="arithmatex">\(\geq \kappa\)</span> can be found or the limit <code>max_iter</code> has 
been reached. Note that <span class="arithmatex">\(\kappa\)</span> is set to <span class="arithmatex">\(0.9\)</span> by default (can be altered
in the configuration file). The mapping extension progress bar keeps track of the 
total number of extended mappings (including the previously predicted ones).</p>
<p>A further filtering will be performed by only preserving mappings with score <span class="arithmatex">\(\geq \lambda\)</span>,
in the original BERTMap paper, <span class="arithmatex">\(\lambda\)</span> is determined by the validation mappings, but
in practice <span class="arithmatex">\(\lambda\)</span> is not a sensitive hyperparameter and validation mappings are often
not available. Therefore, we manually set <span class="arithmatex">\(\lambda\)</span> to <span class="arithmatex">\(0.9995\)</span> by default (can be altered
in the configuration file). The mapping filtering progress bar keeps track of the 
total number of filtered mappings (this bar is purely for logging purpose).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>max_iter</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The maximum number of mapping extension iterations. Defaults to <code>10</code>.</p></td>
          <td>
                <code>10</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/mapping_refinement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mapping_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Iterative mapping extension based on the locality principle.</span>

<span class="sd">    For each class pair $(c, c&#39;)$ (scored in the global matching phase) with score </span>
<span class="sd">    $\geq \kappa$, search for plausible mappings between the parents of $c$ and $c&#39;$,</span>
<span class="sd">    and between the children of $c$ and $c&#39;$. This is an iterative process as the set </span>
<span class="sd">    newly discovered mappings can act renew the frontier for searching. Terminate if</span>
<span class="sd">    no new mappings with score $\geq \kappa$ can be found or the limit `max_iter` has </span>
<span class="sd">    been reached. Note that $\kappa$ is set to $0.9$ by default (can be altered</span>
<span class="sd">    in the configuration file). The mapping extension progress bar keeps track of the </span>
<span class="sd">    total number of extended mappings (including the previously predicted ones).</span>

<span class="sd">    A further filtering will be performed by only preserving mappings with score $\geq \lambda$,</span>
<span class="sd">    in the original BERTMap paper, $\lambda$ is determined by the validation mappings, but</span>
<span class="sd">    in practice $\lambda$ is not a sensitive hyperparameter and validation mappings are often</span>
<span class="sd">    not available. Therefore, we manually set $\lambda$ to $0.9995$ by default (can be altered</span>
<span class="sd">    in the configuration file). The mapping filtering progress bar keeps track of the </span>
<span class="sd">    total number of filtered mappings (this bar is purely for logging purpose).</span>

<span class="sd">    Args:</span>
<span class="sd">        max_iter (int, optional): The maximum number of mapping extension iterations. Defaults to `10`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Extension&quot;</span><span class="p">)</span>
    <span class="n">extension_progress_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span>
        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mapping Extension [Iteration #</span><span class="si">{</span><span class="n">num_iter</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mapping&quot;</span>
    <span class="p">)</span>
    <span class="n">filtering_progress_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span>
        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mapping Filtering&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mapping&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extended_mapping_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found extended and filtered mapping files at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extended_mapping_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Please check file integrity; if incomplete, &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;delete them and re-run the program.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># for animation purposes</span>
        <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mapping Extension&quot;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">EntityMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extended_mapping_path</span><span class="p">):</span>
            <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Filtering&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">EntityMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="p">):</span>
            <span class="n">filtering_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">filtering_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span>
    <span class="c1"># intialise the frontier, explored, final expansion sets with the raw mappings</span>
    <span class="c1"># NOTE be careful of address pointers</span>
    <span class="n">frontier</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_mappings</span><span class="p">]</span>
    <span class="n">expansion</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">with_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_mappings</span><span class="p">]</span>
    <span class="c1"># for animation purposes</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expansion</span><span class="p">)):</span>
        <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Start mapping extension for each class pair with score &gt;= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_extension_threshold</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span>
    <span class="k">while</span> <span class="n">frontier</span> <span class="ow">and</span> <span class="n">num_iter</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
        <span class="n">new_mappings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span> <span class="ow">in</span> <span class="n">frontier</span><span class="p">:</span>
            <span class="c1"># one hop extension makes sure new mappings are really &quot;new&quot;</span>
            <span class="n">cur_new_mappings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_hop_extend</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span><span class="p">)</span>
            <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cur_new_mappings</span><span class="p">))</span>
            <span class="n">new_mappings</span> <span class="o">+=</span> <span class="n">cur_new_mappings</span>
        <span class="c1"># add new mappings to the expansion set</span>
        <span class="n">expansion</span> <span class="o">+=</span> <span class="n">new_mappings</span>
        <span class="c1"># renew frontier with the newly discovered mappings</span>
        <span class="n">frontier</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">new_mappings</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Add </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_mappings</span><span class="p">)</span><span class="si">}</span><span class="s2"> mappings at iteration #</span><span class="si">{</span><span class="n">num_iter</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">num_iter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mapping Extension [Iteration #</span><span class="si">{</span><span class="n">num_iter</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="n">num_extended</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_mappings</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Finished iterative mapping extension with </span><span class="si">{</span><span class="n">num_extended</span><span class="si">}</span><span class="s2"> new mappings and in total </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span><span class="si">}</span><span class="s2"> extended mappings.&quot;</span>
    <span class="p">)</span>

    <span class="n">extended_mapping_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SrcEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;TgtEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;Score&quot;</span><span class="p">])</span>
    <span class="n">extended_mapping_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extended_mapping_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Filtering&quot;</span><span class="p">)</span>

    <span class="n">filtered_expansion</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">expansion</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_filtered_threshold</span>
    <span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Filtered the extended mappings by a threshold of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_filtered_threshold</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_expansion</span><span class="p">)</span><span class="si">}</span><span class="s2"> mappings left for mapping repair.&quot;</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_expansion</span><span class="p">)):</span>
        <span class="n">filtering_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">filtered_mapping_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">filtered_expansion</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SrcEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;TgtEntity&quot;</span><span class="p">,</span> <span class="s2">&quot;Score&quot;</span><span class="p">])</span>
    <span class="n">filtered_mapping_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">extension_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">filtering_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">filtered_expansion</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.mapping_refinement.MappingRefiner.one_hop_extend" class="doc doc-heading">
<code class="highlight language-python"><span class="n">one_hop_extend</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Extend mappings from a scored class pair <span class="arithmatex">\((c, c')\)</span> by
searching from one-hop neighbors.</p>
<p>Search for plausible mappings between the parents of <span class="arithmatex">\(c\)</span> and <span class="arithmatex">\(c'\)</span>,
and between the children of <span class="arithmatex">\(c\)</span> and <span class="arithmatex">\(c'\)</span>. Mappings that are not
already computed (recorded in <code>self.mapping_score_dict</code>) and have
a score $\geq <code>self.mapping_extension_threshold</code> will be returned as
<strong>new</strong> mappings.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_class_iri</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The IRI of the source ontology class <span class="arithmatex">\(c\)</span>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_class_iri</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The IRI of the target ontology class <span class="arithmatex">\(c'\)</span>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>pool_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The maximum number of plausible mappings to be extended. Defaults to 200.</p></td>
          <td>
                <code>200</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="deeponto.align.mapping.EntityMapping" href="../mapping/#deeponto.align.mapping.EntityMapping">EntityMapping</a>]</code>
          </td>
          <td><p>A list of one-hop extended mappings.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/mapping_refinement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">one_hop_extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_class_iri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tgt_class_iri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Extend mappings from a scored class pair $(c, c&#39;)$ by</span>
<span class="sd">    searching from one-hop neighbors.</span>

<span class="sd">    Search for plausible mappings between the parents of $c$ and $c&#39;$,</span>
<span class="sd">    and between the children of $c$ and $c&#39;$. Mappings that are not</span>
<span class="sd">    already computed (recorded in `self.mapping_score_dict`) and have</span>
<span class="sd">    a score $\geq `self.mapping_extension_threshold` will be returned as</span>
<span class="sd">    **new** mappings.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_class_iri (str): The IRI of the source ontology class $c$.</span>
<span class="sd">        tgt_class_iri (str): The IRI of the target ontology class $c&#39;$.</span>
<span class="sd">        pool_size (int, optional): The maximum number of plausible mappings to be extended. Defaults to 200.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[EntityMapping]): A list of one-hop extended mappings.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">src_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">get_owl_object_from_iri</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">)</span>
    <span class="n">src_class_parent_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">reasoner</span><span class="o">.</span><span class="n">super_entities_of</span><span class="p">(</span><span class="n">src_class</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">src_class_children_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">reasoner</span><span class="o">.</span><span class="n">sub_entities_of</span><span class="p">(</span><span class="n">src_class</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">tgt_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">get_owl_object_from_iri</span><span class="p">(</span><span class="n">tgt_class_iri</span><span class="p">)</span>
    <span class="n">tgt_class_parent_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">reasoner</span><span class="o">.</span><span class="n">super_entities_of</span><span class="p">(</span><span class="n">tgt_class</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tgt_class_children_iris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">reasoner</span><span class="o">.</span><span class="n">sub_entities_of</span><span class="p">(</span><span class="n">tgt_class</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># pair up parents and children, respectively; NOTE set() might not be necessary</span>
    <span class="n">parent_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_parent_iris</span><span class="p">,</span> <span class="n">tgt_class_parent_iris</span><span class="p">)))</span>
    <span class="n">children_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">src_class_children_iris</span><span class="p">,</span> <span class="n">tgt_class_children_iris</span><span class="p">)))</span>

    <span class="n">candidate_pairs</span> <span class="o">=</span> <span class="n">parent_pairs</span> <span class="o">+</span> <span class="n">children_pairs</span>
    <span class="c1"># downsample if the number of candidates is too large</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pool_size</span><span class="p">:</span>
        <span class="n">candidate_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">candidate_pairs</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">)</span>

    <span class="n">extended_mappings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">src_candidate_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span> <span class="ow">in</span> <span class="n">parent_pairs</span> <span class="o">+</span> <span class="n">children_pairs</span><span class="p">:</span>

        <span class="c1"># if already computed meaning that it is not a new mapping</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">src_candidate_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_score_dict</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">src_candidate_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">src_annotation_index</span><span class="p">[</span><span class="n">src_candidate_iri</span><span class="p">]</span>
        <span class="n">tgt_candidate_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">tgt_annotation_index</span><span class="p">[</span><span class="n">tgt_candidate_iri</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_predictor</span><span class="o">.</span><span class="n">bert_mapping_score</span><span class="p">(</span><span class="n">src_candidate_annotations</span><span class="p">,</span> <span class="n">tgt_candidate_annotations</span><span class="p">)</span>
        <span class="c1"># add to already scored collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_score_dict</span><span class="p">[(</span><span class="n">src_candidate_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span><span class="p">)]</span> <span class="o">=</span> <span class="n">score</span>

        <span class="c1"># skip mappings with low scores</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_extension_threshold</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">extended_mappings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">src_candidate_iri</span><span class="p">,</span> <span class="n">tgt_candidate_iri</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;New mappings (in tuples) extended from </span><span class="si">{</span><span class="p">(</span><span class="n">src_class_iri</span><span class="p">,</span><span class="w"> </span><span class="n">tgt_class_iri</span><span class="p">)</span><span class="si">}</span><span class="s2"> are:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extended_mappings</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">extended_mappings</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.mapping_refinement.MappingRefiner.mapping_repair" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mapping_repair</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Repair the filtered mappings with LogMap's debugger.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A sub-folder under <code>match</code> named <code>logmap-repair</code> contains LogMap-related intermediate files.</p>
</div>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/mapping_refinement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mapping_repair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Repair the filtered mappings with LogMap&#39;s debugger.</span>

<span class="sd">    !!! note</span>

<span class="sd">        A sub-folder under `match` named `logmap-repair` contains LogMap-related intermediate files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># progress bar for animation purposes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">demo</span><span class="o">=</span><span class="s2">&quot;Mapping Repairing&quot;</span><span class="p">)</span>
    <span class="n">repair_progress_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlighten_manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span>
        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mapping Repairing&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mapping&quot;</span>
    <span class="p">)</span>

    <span class="c1"># skip repairing if already found the file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repaired_mapping_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found the repaired mapping file at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repaired_mapping_path</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Please check file integrity; if incomplete, &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;delete it and re-run the program.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># update progress bar for animation purposes</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">EntityMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repaired_mapping_path</span><span class="p">):</span>
            <span class="n">repair_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">repair_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> 

    <span class="c1"># start mapping repair</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Repair the filtered mappings with LogMap debugger.&quot;</span><span class="p">)</span>
    <span class="c1"># formatting the filtered mappings</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_formatting</span><span class="p">()</span>

    <span class="c1"># run the LogMap repair module on the extended mappings</span>
    <span class="n">run_logmap_repair</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_onto</span><span class="o">.</span><span class="n">owl_path</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_onto</span><span class="o">.</span><span class="n">owl_path</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;filtered_mappings_for_LogMap_repair.txt&quot;</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># create table mappings from LogMap repair outputs</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">,</span> <span class="s2">&quot;mappings_repaired_with_LogMap.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span> <span class="s2">&quot;repaired_mappings.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;SrcEntity</span><span class="se">\t</span><span class="s2">TgtEntity</span><span class="se">\t</span><span class="s2">Score</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">src_ent_iri</span><span class="p">,</span> <span class="n">tgt_ent_iri</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_ent_iri</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tgt_ent_iri</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">repair_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mapping repair finished.&quot;</span><span class="p">)</span>
    <span class="n">repair_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="deeponto.align.bertmap.mapping_refinement.MappingRefiner.logmap_repair_formatting" class="doc doc-heading">
<code class="highlight language-python"><span class="n">logmap_repair_formatting</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Transform the filtered mapping file into the LogMap format.</p>
<p>An auxiliary function of the mapping repair module which requires mappings
to be formatted as LogMap's input format.</p>

      <details class="quote">
        <summary>Source code in <code>deeponto/align/bertmap/mapping_refinement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">logmap_repair_formatting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform the filtered mapping file into the LogMap format.</span>

<span class="sd">    An auxiliary function of the mapping repair module which requires mappings</span>
<span class="sd">    to be formatted as LogMap&#39;s input format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read the filtered mapping file and convert to tuples</span>
    <span class="n">filtered_mappings</span> <span class="o">=</span> <span class="n">EntityMapping</span><span class="o">.</span><span class="n">read_table_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_mapping_path</span><span class="p">)</span>
    <span class="n">filtered_mappings_in_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">with_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">filtered_mappings</span><span class="p">]</span>

    <span class="c1"># write the mappings into logmap format</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">src_class_iri</span><span class="p">,</span> <span class="n">tgt_class_iri</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">filtered_mappings_in_tuples</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_class_iri</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">tgt_class_iri</span><span class="si">}</span><span class="s2">|=|</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">|CLS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># create a path to prevent error</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="n">create_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">)</span>
    <span class="n">formatted_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logmap_repair_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;filtered_mappings_for_LogMap_repair.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">formatted_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lines</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 24, 2023</span>
      
        <br>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 13, 2023</span>
      
    
  </small>
</div>





                

  
    <div class="md-source-date">
      <small>
        <span class="twemoji">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> 
        </span>
        GitHub: <span class='git-page-authors'><a href='https://github.com/Lawhy'>@Lawhy</a>
        &nbsp;
        <span class="twemoji">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c.2 35.5-28.5 64.3-64 64.3H128.1c-35.3 0-64-28.7-64-64V287.6H32c-18 0-32-14-32-32.1 0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7l255.4 224.5c8 7 12 15 11 24zM352 224c0-35.3-28.7-64-64-64s-64 28.7-64 64 28.7 64 64 64 64-28.7 64-64zm-96 96c-44.2 0-80 35.8-80 80 0 8.8 7.2 16 16 16h192c8.8 0 16-7.2 16-16 0-44.2-35.8-80-80-80h-64z"/></svg> 
        </span>
        Personal Page: <span class='git-page-authors'><a href='https://www.yuanhe.wiki/'>yuanhe.wiki</a>
      </small>
    </div>
  

              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 Yuan He (KRR-Oxford)
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://pypi.org/project/deeponto/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/Lawhy" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/YuanHe97" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections", "toc.integrate", "navigation.top", "header.autohide", "toc.follow", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": "0.5.0"}</script>
    
    
      <script src="../../../assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>